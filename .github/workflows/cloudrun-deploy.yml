name: Deploy to Cloud Run

on:
  push:
    branches: [ feature/deploy ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT }}

    - name: Enable required GCP services
      run: |
        gcloud services enable run.googleapis.com secretmanager.googleapis.com cloudbuild.googleapis.com

    - name: Create or update Firebase secret in Secret Manager
      env:
        FIREBASE_SA_JSON: ${{ secrets.FIREBASE_SA_JSON }}
      run: |
        set -e
        if gcloud secrets describe firebase-service-account >/dev/null 2>&1; then
          echo "Adding new secret version"
          echo "$FIREBASE_SA_JSON" | gcloud secrets versions add firebase-service-account --data-file=-
        else
          echo "Creating secret and adding version"
          echo "$FIREBASE_SA_JSON" | gcloud secrets create firebase-service-account --data-file=-
        fi

    - name: Build and push container image
      env:
        IMAGE: gcr.io/${{ secrets.GCP_PROJECT }}/codewithmorais:${{ github.sha }}
      run: |
        gcloud builds submit --tag $IMAGE

    - name: Deploy to Cloud Run
      env:
        IMAGE: gcr.io/${{ secrets.GCP_PROJECT }}/codewithmorais:${{ github.sha }}
      run: |
        gcloud run deploy codewithmorais \
          --image $IMAGE \
          --region ${{ secrets.GCP_REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --set-secrets SERVICE_ACCOUNT_JSON=firebase-service-account:latest \
          --set-env-vars GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
