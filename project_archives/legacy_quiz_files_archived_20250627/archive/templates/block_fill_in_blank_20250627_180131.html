{# Fill in the Blank Quiz Block: Accessible and robust for student lessons #}
{% set q = (block.questions[0] if block.questions and block.questions|length > 0 else block if (block.question is defined or block.answers is defined) else None) %}
{% if q and q.answers is defined and q.answers|length > 0 %}
  <div class="quiz-block block-fill-in-blank fitb-container" 
       data-block-id="{{ block.id }}" 
       data-question-type="fill_in_blank"
       data-answers="{{ q.answers|join(',') }}"
       data-points="{{ q.points | default(1) }}"
       role="group" 
       aria-labelledby="fitb-question-{{ block.id }}">
    
    <div class="mcq-ribbon">
      Quiz
    </div>
    
    <div class="fitb-header">
      {% if q.instructions or block.instructions %}
        <p class="fitb-instructions">{{ q.instructions or block.instructions }}</p>
      {% endif %}
      {% if q.title or block.title %}
        <h4 class="fitb-title">{{ q.title or block.title }}</h4>
      {% endif %}
      <div id="fitb-question-{{ block.id }}" class="fitb-question">
        {{ (q.question or block.question)|markdown|safe }}
      </div>
    </div>
    
    <div class="fitb-input-section">
      <label for="fitb-input-{{ block.id }}" class="visually-hidden">
        Your answer for: {{ (q.question or block.question)|striptags }}
      </label>
      <input type="text" 
             id="fitb-input-{{ block.id }}"
             class="fitb-input" 
             autocomplete="off" 
             autocapitalize="off"
             spellcheck="false"
             aria-describedby="fitb-feedback-{{ block.id }} fitb-help-{{ block.id }}"
             placeholder="Type your answer here..." />
      
      <div id="fitb-help-{{ block.id }}" class="fitb-help-text">
        {% if q.case_sensitive %}
          <small>Note: This answer is case-sensitive.</small>
        {% else %}
          <small>Note: Case doesn't matter for this answer.</small>
        {% endif %}
      </div>
      
      <button type="button" 
              class="btn btn-primary fitb-submit-btn"
              aria-describedby="fitb-feedback-{{ block.id }}">
        <span class="material-symbols-outlined">check</span>
        Submit Answer
      </button>
    </div>
    
    <div class="fitb-footer">
      <div id="fitb-feedback-{{ block.id }}" 
           class="quiz-feedback fitb-feedback display-none" 
           aria-live="polite" 
           role="status"></div>
      
      {% if q.explanation %}
        <div class="fitb-explanation display-none" id="fitb-explanation-{{ block.id }}">
          <h5>Explanation:</h5>
          <p>{{ q.explanation|markdown|safe }}</p>
        </div>
      {% endif %}
      
      {% if q.hint and q.hint_cost is defined %}
        <div class="hint-section">
          <button class="btn btn-hint" 
                  data-block-id="{{ block.id }}" 
                  data-hint-cost="{{ q.hint_cost }}"
                  aria-describedby="fitb-hint-description-{{ block.id }}">
            <span class="material-symbols-outlined">lightbulb</span>
            Show Hint ({{ q.hint_cost }} <img src="{{ url_for('static', filename='img/pycoin-icon.svg') }}" class="pycoin-icon coin-icon" alt="PyCoins">)
          </button>
          <div id="fitb-hint-description-{{ block.id }}" class="visually-hidden">
            Purchase a hint for this question using {{ q.hint_cost }} PyCoins
          </div>
          <div class="hint-content display-none" id="hint-{{ block.id }}" role="region" aria-label="Question hint"></div>
        </div>
      {% endif %}
    </div>
    
    <!-- Quiz 2.1: Inline Summary Section for single questions -->
    <div class="quiz-summary-inline" style="display: none;">
        <div class="quiz-summary-header text-center mt-3">
            <h5 class="text-success mb-2">ðŸŽ‰ Question Complete!</h5>
            <div class="quiz-summary-stats">
                <div class="score-display">
                    Score: <span class="summary-score font-weight-bold text-primary">1/1 (100%)</span>
                </div>
                <div class="points-earned mt-2">
                    <span class="badge badge-success summary-points">+{{ q.points | default(1) }} XP</span>
                </div>
            </div>
        </div>
        <div class="quiz-summary-actions text-center mt-3">
            <button class="btn btn-outline-primary btn-sm retake-quiz-btn">
                ðŸ”„ Retake Question (10 PyCoins)
            </button>
        </div>
    </div>
  </div>
{% else %}
  <div class="quiz-block block-fill-in-blank question-wrapper quiz-error" 
       data-block-id="{{ block.id }}" 
       data-question-type="fill_in_blank"
       role="alert">
    <div class="error-content">
      <span class="material-symbols-outlined error-icon">error</span>
      <div class="error-text">
        <h4>Quiz Configuration Error</h4>
        <p>This fill-in-the-blank question is missing valid answers.</p>
        {% if config.DEBUG %}
          <details class="debug-info">
            <summary>Debug Information</summary>
            <pre>block = {{ block|tojson(indent=2) }}</pre>
          </details>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}
