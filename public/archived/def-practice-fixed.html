<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ DEF Practice Arena - Level Up Your Python Skills! | Code with Morais</title>
    
    <!-- Prism.js for professional Python syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- Confetti.js for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Firebase SDK - Using modular approach -->
    <script src="firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 20px;
            animation: gradientShift 10s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
            50% { background: linear-gradient(135deg, #f093fb 0%, #667eea 50%, #764ba2 100%); }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), 0 0 100px rgba(102, 126, 234, 0.2);
            overflow: hidden;
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4ecdc4, #45b7d1);
            animation: rainbow 3s linear infinite;
        }

        @keyframes rainbow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            color: white;
            padding: 50px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .quiz-info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: bold;
        }

        .login-section {
            padding: 40px 30px;
            text-align: center;
        }

        .google-login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .google-login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }

        .user-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #28a745;
        }

        .quiz-content {
            padding: 30px;
            display: none;
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 30px;
            height: 20px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 25px;
        }

        .question-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .difficulty-beginner .difficulty-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .difficulty-advanced .difficulty-badge {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .difficulty-expert .difficulty-badge {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .difficulty-beginner {
            border-left: 5px solid #28a745;
        }

        .difficulty-advanced {
            border-left: 5px solid #ffc107;
            background: linear-gradient(to right, rgba(255, 193, 7, 0.05), white);
        }

        .difficulty-expert {
            border-left: 5px solid #dc3545;
            background: linear-gradient(to right, rgba(220, 53, 69, 0.05), white);
        }

        .question-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.3rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .question-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            min-height: 400px;
        }

        .question-container:hover {
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .code-block {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007acc;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .code-block::before {
            content: "Python";
            position: absolute;
            top: 8px;
            right: 12px;
            background: #007acc;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .code-block pre {
            margin: 0;
            padding: 0;
            background: transparent !important;
            border: none !important;
            font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
            overflow: visible;
        }

        .code-block code {
            background: transparent !important;
            padding: 0 !important;
            color: inherit !important;
            font-family: inherit !important;
            font-size: inherit !important;
        }

        /* Custom Python syntax highlighting improvements */
        .code-block .token.keyword {
            color: #ff79c6 !important;
            font-weight: bold;
        }

        .code-block .token.function {
            color: #50fa7b !important;
        }

        .code-block .token.string {
            color: #f1fa8c !important;
        }

        .code-block .token.number {
            color: #bd93f9 !important;
        }

        .code-block .token.operator {
            color: #ff79c6 !important;
        }

        .code-block .token.comment {
            color: #6272a4 !important;
            font-style: italic;
        }

        .code-block .token.punctuation {
            color: #f8f8f2 !important;
        }

        .code-block .token.builtin {
            color: #8be9fd !important;
        }

        /* Line numbers styling */
        .code-block .line-numbers {
            position: absolute;
            top: 0;
            left: 0;
            width: 3em;
            letter-spacing: -1px;
            border-right: 1px solid #44475a;
            user-select: none;
            pointer-events: none;
        }

        .code-block .line-numbers-rows {
            position: absolute;
            pointer-events: none;
            top: 0;
            font-size: 100%;
            left: -3.8em;
            width: 3em;
            letter-spacing: -1px;
            border-right: 1px solid #44475a;
            user-select: none;
        }

        .code-block .line-numbers-rows > span {
            display: block;
            counter-increment: linenumber;
        }

        .code-block .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #6272a4;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
            flex: 1;
        }

        .question-content-wrapper {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin-top: 20px;
        }

        .question-powerups {
            min-width: 200px;
            flex-shrink: 0;
        }

        .powerup-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #dee2e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .powerup-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
            text-align: center;
        }

        .powerup-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            background: white;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .powerup-icon {
            font-size: 1.2rem;
        }

        .powerup-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            font-size: 0.9rem;
        }

        .powerup-use-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .powerup-use-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .powerup-use-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .powerup-help {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
            margin-top: 8px;
            line-height: 1.3;
        }

        /* Responsive layout for smaller screens */
        @media (max-width: 768px) {
            .question-content-wrapper {
                flex-direction: column;
                gap: 20px;
            }
            
            .question-powerups {
                min-width: auto;
                width: 100%;
            }
            
            .powerup-section {
                padding: 15px;
            }
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .option.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .feedback {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .feedback.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .next-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: none;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .results-section {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #28a745;
            margin: 20px 0;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .score-item {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .retry-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 10px;
            transition: all 0.3s ease;
        }

        .second-chance-section {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
            border: 2px solid #ff9a9e;
        }

        .second-chance-info h3 {
            color: #d63384;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .second-chance-info p {
            color: #6f42c1;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .second-chance-benefits {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .benefit-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 15px;
            border-radius: 15px;
            color: #495057;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .second-chance-btn {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .second-chance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .was-selected {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }

        .second-chance-hint {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            border-left: 5px solid #2196f3;
        }

        .hint-header {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .hint-text {
            color: #455a64;
            font-style: italic;
        }

        .second-chance-results {
            text-align: center;
            padding: 20px;
        }

        .second-chance-results .score-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .performance-message {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #5a6268;
        }

        .admin-btn {
            background: linear-gradient(135deg, #fd7e14, #e55a00);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 5px;
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.4);
        }

        .period-change-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 5px;
        }

        .period-change-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .quiz-content {
                padding: 20px 15px;
            }
            
            .question-card {
                padding: 20px;
            }
        }

        /* Gamification Styles */
        .game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(145deg, #fff, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .streak-indicator {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            animation: pulse 2s infinite;
        }

        .achievement-badge {
            background: linear-gradient(45deg, #48dbfb, #0abde3);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 5px;
            display: inline-block;
            animation: bounce 1s;
        }

        .correct-feedback {
            background: linear-gradient(45deg, #2ecc71, #27ae60) !important;
            color: white !important;
            transform: scale(1.05);
            animation: correctPulse 0.6s ease;
        }

        .wrong-feedback {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
            color: white !important;
            animation: shake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-30px,0); }
            70% { transform: translate3d(0,-15px,0); }
            90% { transform: translate3d(0,-4px,0); }
        }

        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            font-size: 1.5rem;
            font-weight: bold;
            animation: levelUp 3s ease forwards;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes levelUp {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .points-animation {
            position: absolute;
            top: -20px;
            right: 20px;
            color: #2ecc71;
            font-weight: bold;
            font-size: 1.2rem;
            animation: pointsFloat 2s ease forwards;
            pointer-events: none;
        }

        @keyframes pointsFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        /* Enhanced Header Styles */
        .header-content h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: titlePulse 2s ease infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header-decorations {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .decoration {
            font-size: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        .decoration:nth-child(1) { animation-delay: 0s; }
        .decoration:nth-child(2) { animation-delay: 0.5s; }
        .decoration:nth-child(3) { animation-delay: 1s; }
        .decoration:nth-child(4) { animation-delay: 1.5s; }
        .decoration:nth-child(5) { animation-delay: 2s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Game Stats Enhanced */
        .game-stats {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px;
            display: flex;
            justify-content: space-around;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .game-stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .stat-item {
            text-align: center;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: scale(1.05);
        }

        .stat-value {
            display: block;
            font-size: 2.2rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        /* Enhanced individual stat styling */
        .stat-item:nth-child(1) .stat-value { /* Score */
            color: #ffd93d;
            text-shadow: 0 0 10px rgba(255, 217, 61, 0.6);
        }

        .stat-item:nth-child(2) .stat-value { /* Streak */
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
        }

        .stat-item:nth-child(3) .stat-value { /* Level */
            color: #6bcf7f;
            text-shadow: 0 0 10px rgba(107, 207, 127, 0.6);
        }

        .stat-item:nth-child(4) .stat-value { /* Power-ups */
            color: #ff9a9e;
            text-shadow: 0 0 15px rgba(255, 154, 158, 0.8);
            animation: powerUpPulse 2s infinite;
        }

        .stat-item:nth-child(5) .stat-value { /* Time Bonus */
            color: #4ecdc4;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.6);
        }

        /* Power-up pulse animation */
        @keyframes powerUpPulse {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 0 0 15px rgba(255, 154, 158, 0.8);
            }
            50% { 
                transform: scale(1.1);
                text-shadow: 0 0 25px rgba(255, 154, 158, 1);
            }
        }

        /* Enhanced streak styling */
        .streak-active {
            animation: streakGlow 1s infinite;
        }

        @keyframes streakGlow {
            0%, 100% { 
                color: #ff6b6b;
                text-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
            }
            50% { 
                color: #fff;
                text-shadow: 0 0 20px rgba(255, 107, 107, 1);
            }
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Question Card Enhanced */
        .question-card {
            background: white !important;
            border-radius: 20px !important;
            padding: 35px !important;
            margin: 25px auto !important;
            max-width: 900px !important;
            min-height: 450px !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important;
            border: 3px solid transparent !important;
            background-clip: padding-box !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4ecdc4, #45b7d1);
        }

        /* Enhanced Progress Bar */
        .progress-container {
            position: relative;
            margin: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 25px;
            overflow: hidden;
            height: 25px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 25px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        /* Enhanced Answer Options */
        .answer-option {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .answer-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .answer-option:hover::before {
            left: 100%;
        }

        .answer-option:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .answer-option.correct {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            animation: correctPulse 1s ease;
        }

        .answer-option.incorrect {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Power-up and Streak Indicators */
        .power-up-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffd93d, #ff9a9e);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(255, 217, 61, 0.3);
            animation: powerUpGlow 2s ease infinite;
            z-index: 1000;
        }

        @keyframes powerUpGlow {
            0%, 100% { box-shadow: 0 10px 25px rgba(255, 217, 61, 0.3); }
            50% { box-shadow: 0 15px 35px rgba(255, 217, 61, 0.6); }
        }

        .streak-counter {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            animation: streakBounce 0.5s ease;
            z-index: 1000;
        }

        @keyframes streakBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Power-up use button */
        .power-up-use-btn {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .power-up-use-btn:hover {
            background: linear-gradient(135deg, #ff6b6b, #ff9a9e);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
        }

        .power-up-use-btn:active {
            transform: scale(0.95);
        }

        /* Leaderboard Styles */
        .leaderboard-section {
            background: white;
            margin: 20px auto;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
            max-width: 600px;
            width: 100%;
        }

        .leaderboard-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ffd700, #ff6b6b, #6bcf7f, #4ecdc4, #45b7d1);
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .leaderboard-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #667eea;
            transition: transform 0.3s ease;
            padding: 5px;
            border-radius: 4px;
        }

        .collapse-btn:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .collapse-btn.collapsed {
            transform: rotate(-90deg);
        }

        .leaderboard-content-wrapper {
            transition: max-height 0.5s ease, opacity 0.5s ease;
            overflow: hidden;
            max-height: 1000px;
        }

        .leaderboard-content-wrapper.collapsed {
            max-height: 0 !important;
            opacity: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .leaderboard-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .period-selector {
            margin: 15px 0;
            text-align: center;
        }

        .period-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .period-selector select {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        .period-selector select:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .period-selector select option {
            background: white;
            color: #2c3e50;
            padding: 10px;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .leaderboard-item:nth-child(1) {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b6914;
            font-weight: bold;
            border: 2px solid #ffd700;
        }

        .leaderboard-item:nth-child(2) {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #5a5a5a;
            font-weight: bold;
            border: 2px solid #c0c0c0;
        }

        .leaderboard-item:nth-child(3) {
            background: linear-gradient(135deg, #cd7f32, #e6a85c);
            color: #5c3d1a;
            font-weight: bold;
            border: 2px solid #cd7f32;
        }

        .leaderboard-item:nth-child(n+4) {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }

        .leaderboard-rank:nth-child(1) { color: #ffd700; }
        .leaderboard-rank:nth-child(2) { color: #c0c0c0; }
        .leaderboard-rank:nth-child(3) { color: #cd7f32; }

        .leaderboard-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin: 0 15px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-details {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .leaderboard-score {
            text-align: right;
            font-weight: bold;
        }

        .leaderboard-score-value {
            font-size: 1.3rem;
            display: block;
        }

        .leaderboard-score-label {
            font-size: 0.7rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .leaderboard-crown {
            position: absolute;
            top: -5px;
            right: 10px;
            font-size: 1.5rem;
            animation: crownFloat 2s ease-in-out infinite;
        }

        @keyframes crownFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .leaderboard-loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .leaderboard-empty {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .leaderboard-toggle-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .leaderboard-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üéÆ DEF Practice Arena üèÜ</h1>
                <p>Master Python Functions Through Epic Challenges!</p>
                <div class="header-decorations">
                    <span class="decoration">‚ö°</span>
                    <span class="decoration">üíé</span>
                    <span class="decoration">üî•</span>
                    <span class="decoration">üåü</span>
                    <span class="decoration">‚ö°</span>
                </div>
            </div>
        </div>

        <!-- Game Stats Section -->
        <div class="game-stats" id="gameStats" style="display: none;">
            <div class="stat-item">
                <span class="stat-value" id="playerScore">0</span>
                <span class="stat-label">‚≠ê Score</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="currentStreak">0</span>
                <span class="stat-label">üî• Streak</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="playerLevel">1</span>
                <span class="stat-label">üèÜ Level</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="powerUps">0</span>
                <span class="stat-label">‚ö° Power-ups</span>
                <button onclick="usePowerUp()" id="powerUpBtn" class="power-up-use-btn" style="display: none;">USE</button>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="timeBonus">0</span>
                <span class="stat-label">‚è±Ô∏è Time Bonus</span>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div class="leaderboard-section" id="leaderboardSection" style="display: none;">
            <div class="leaderboard-header">
                <div class="leaderboard-title">
                    <span>üèÜ Period Leaderboard</span>
                    <button class="collapse-btn" id="leaderboardToggle" onclick="toggleLeaderboard()" title="Collapse/Expand Leaderboard">
                        ‚ñº
                    </button>
                </div>
                <div class="leaderboard-content-wrapper" id="leaderboardContentWrapper">
                    <div class="leaderboard-subtitle">Select your class period</div>
                
                <!-- Period Selector -->
                <div class="period-selector">
                    <label for="periodSelect">Class Period:</label>
                    <select id="periodSelect" onchange="onPeriodChange()">
                        <option value="">Select Period</option>
                        <option value="1">Period 1</option>
                        <option value="3">Period 3</option>
                        <option value="6">Period 6</option>
                    </select>
                </div>
            <div id="leaderboardContent">
                <div class="leaderboard-empty">
                    <div>üìö Select your period to view rankings</div>
                </div>
            </div>
            <button class="leaderboard-toggle-btn" onclick="refreshLeaderboard()" id="refreshBtn" style="display: none;">
                üîÑ Refresh Rankings
            </button>
            </div>
        </div>
                <div class="leaderboard-empty">
                    <div>ÔøΩ Select your period to view rankings</div>
                </div>
            </div>
            <button class="leaderboard-toggle-btn" onclick="refreshLeaderboard()" id="refreshBtn" style="display: none;">
                üîÑ Refresh Rankings
            </button>
        </div>

        <!-- Power-up and Streak Indicators -->
        <div class="power-up-indicator" id="powerUpIndicator" style="display: none;">
            üöÄ POWER-UP ACTIVATED!
        </div>
        <div class="streak-counter" id="streakCounter" style="display: none;">
            üî• STREAK: <span id="streakNumber">0</span>
        </div>

        <div class="quiz-info">
            <span class="icon">ÔøΩ</span>
            <strong>25 Epic Challenges ‚Ä¢ Master Python Functions</strong><br>
            Earn streaks, unlock power-ups, and compete with your classmates!<br>
            <small style="color: #6c757d;">üí° Choose your class period to see period-specific leaderboards</small>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">Sign in to start the quiz</h2>
            <p style="margin-bottom: 30px; color: #6c757d;">Your progress and scores will be saved to your account</p>
            <button class="google-login-btn" onclick="handleGoogleSignIn()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- Quiz Content -->
        <div class="quiz-content" id="quizContent">
            <div class="user-info" id="userInfo"></div>
            
            <div class="progress-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: bold; color: #667eea;">Progress</span>
                    <span id="questionCounter" style="font-weight: bold; color: #764ba2;">1 / 45</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">4%</div>
                </div>
            </div>
            
            <!-- Emergency Help Button -->
            <div style="text-align: right; margin: 10px 0;">
                <button onclick="showEmergencyHelp()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    cursor: pointer;
                    opacity: 0.7;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                    üÜò Need Help?
                </button>
            </div>
            
            <div id="quizQuestions"></div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h2>üéâ Quiz Complete!</h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="score-breakdown" id="scoreBreakdown"></div>
            <div class="second-chance-section" id="secondChanceSection" style="display: none;">
                <div class="second-chance-info">
                    <h3>üéØ Second Chance Available!</h3>
                    <p>You got <span id="wrongCount"></span> questions wrong. Want to try them again?</p>
                    <div class="second-chance-benefits">
                        <div class="benefit-item">‚ú® Earn bonus points for corrections</div>
                        <div class="benefit-item">üöÄ Gain extra power-ups for streaks</div>
                        <div class="benefit-item">üìà Improve your overall score</div>
                    </div>
                </div>
                <button class="second-chance-btn" onclick="startSecondChance()">üîÑ Take Second Chance</button>
            </div>
            <button class="retry-btn" onclick="restartQuiz()">üîÑ Retake Quiz</button>
            <button class="retry-btn" onclick="window.location.href='def-advanced.html'">üìö Back to Lessons</button>
        </div>
    </div>

    <script type="module">
        // Global sign-in function available immediately
        window.handleGoogleSignIn = function() {
            if (window.signInWithGoogle) {
                window.signInWithGoogle();
            } else {
                alert('Google Sign-In is loading... Please try again in a moment.');
                console.log('signInWithGoogle not ready yet');
            }
        };

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, onSnapshot, orderBy, query, getDocs, limit, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Initialize Firebase
        let firebaseConfig;
        let app, auth, db, currentUser;

        async function initFirebase() {
            try {
                firebaseConfig = window.firebaseConfig;
                if (!firebaseConfig) {
                    throw new Error('Firebase configuration not found');
                }
                
                // Use Firebase hosting domain for auth if we're on Firebase hosting
                if (window.location.hostname.includes('web.app') || window.location.hostname.includes('firebaseapp.com')) {
                    firebaseConfig = {
                        ...firebaseConfig,
                        authDomain: "code-with-morais-405.firebaseapp.com"
                    };
                    console.log('Using Firebase hosting auth domain');
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        // Wait for config to load, then initialize
        window.addEventListener('load', async () => {
            await initFirebase();
            
            // Check for redirect result
            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    console.log('Redirect sign in successful:', result);
                }
            } catch (error) {
                console.error('Redirect result error:', error);
            }
        });

        // Make functions globally accessible
        window.signInWithGoogle = async function() {
            try {
                // Check if Firebase is initialized
                if (!auth) {
                    console.log('Firebase not initialized yet, initializing now...');
                    await initFirebase();
                    // Wait a bit for initialization
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (!auth) {
                    throw new Error('Firebase authentication not available');
                }
                
                console.log('Attempting Google sign in...');
                console.log('Auth object:', auth);
                console.log('Firebase config:', firebaseConfig);
                
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                console.log('Provider created:', provider);
                
                try {
                    // Try popup first
                    const result = await signInWithPopup(auth, provider);
                    console.log('Sign in successful:', result);
                } catch (popupError) {
                    console.log('Popup failed, trying redirect...', popupError);
                    // If popup fails, try redirect
                    await signInWithRedirect(auth, provider);
                }
            } catch (error) {
                console.error('Login error details:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMessage = 'Login failed. ';
                if (error.code === 'auth/popup-blocked') {
                    errorMessage += 'Popup was blocked. Please allow popups for this site.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage += 'Popup was closed before completing sign in.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage += 'Network error. Please check your connection.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage += 'This domain is not authorized for OAuth operations.';
                } else {
                    errorMessage += `Error: ${error.message}`;
                }
                
                alert(errorMessage);
            }
        };

        // Gamification Enhancement Functions
        function updateGameStats() {
            // Update basic stats
            document.getElementById('playerScore').textContent = playerScore;
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('playerLevel').textContent = playerLevel;
            document.getElementById('powerUps').textContent = powerUps;
            document.getElementById('timeBonus').textContent = totalTimeBonus;
            
            // Update question-level power-up display
            updatePowerUpDisplay();
            
            // Enhanced power-up styling
            const powerUpElement = document.getElementById('powerUps');
            const powerUpBtn = document.getElementById('powerUpBtn');
            
            if (powerUps > 0) {
                powerUpElement.style.animation = 'powerUpPulse 1.5s infinite';
                powerUpElement.style.fontSize = '2.5rem';
                powerUpElement.style.color = '#ff9a9e';
                powerUpElement.style.textShadow = '0 0 20px rgba(255, 154, 158, 1)';
                powerUpBtn.style.display = 'block';
            } else {
                powerUpElement.style.animation = 'none';
                powerUpElement.style.fontSize = '2.2rem';
                powerUpElement.style.color = '#ff9a9e';
                powerUpElement.style.textShadow = '0 0 10px rgba(255, 154, 158, 0.6)';
                powerUpBtn.style.display = 'none';
            }
            
            // Enhanced streak styling
            const streakElement = document.getElementById('currentStreak');
            if (currentStreak >= 5) {
                streakElement.classList.add('streak-active');
                streakElement.style.fontSize = '2.5rem';
            } else if (currentStreak >= 3) {
                streakElement.classList.remove('streak-active');
                streakElement.style.fontSize = '2.3rem';
                streakElement.style.color = '#ff6b6b';
                streakElement.style.textShadow = '0 0 15px rgba(255, 107, 107, 0.8)';
            } else {
                streakElement.classList.remove('streak-active');
                streakElement.style.fontSize = '2.2rem';
                streakElement.style.color = '#ff6b6b';
                streakElement.style.textShadow = '0 0 10px rgba(255, 107, 107, 0.6)';
            }
            
            // Level styling based on achievement
            const levelElement = document.getElementById('playerLevel');
            if (playerLevel > 1) {
                levelElement.style.fontSize = '2.4rem';
                levelElement.style.color = '#6bcf7f';
                levelElement.style.textShadow = '0 0 15px rgba(107, 207, 127, 0.8)';
            }
            
            // Score styling for big numbers
            const scoreElement = document.getElementById('playerScore');
            if (playerScore >= 1000) {
                scoreElement.style.fontSize = '2.1rem';
                scoreElement.style.color = '#ffd93d';
                scoreElement.style.textShadow = '0 0 15px rgba(255, 217, 61, 0.8)';
            }
            
            // Time bonus highlighting
            const timeBonusElement = document.getElementById('timeBonus');
            if (totalTimeBonus > 0) {
                timeBonusElement.style.color = '#4ecdc4';
                timeBonusElement.style.textShadow = '0 0 12px rgba(78, 205, 196, 0.7)';
            }
            
            // Update progress text and counter
            const progressPercent = Math.round(((currentQuestionIndex + 1) / questions.length) * 100);
            document.getElementById('progressText').textContent = `${progressPercent}%`;
            document.getElementById('questionCounter').textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
            
            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${progressPercent}%`;
        }

        function calculateTimeBonus() {
            if (!questionStartTime) return 0;
            
            const timeSpent = (new Date() - questionStartTime) / 1000; // seconds
            let bonus = 0;
            
            if (timeSpent < 10) {
                bonus = 50; // Lightning fast!
            } else if (timeSpent < 20) {
                bonus = 30; // Very fast!
            } else if (timeSpent < 30) {
                bonus = 15; // Fast!
            } else if (timeSpent < 45) {
                bonus = 5; // Good timing
            }
            
            return bonus;
        }

        function showStreakIndicator() {
            const streakCounter = document.getElementById('streakCounter');
            const streakNumber = document.getElementById('streakNumber');
            
            streakNumber.textContent = currentStreak;
            streakCounter.style.display = 'block';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                streakCounter.style.display = 'none';
            }, 3000);
        }

        function showPowerUpIndicator(message) {
            const powerUpIndicator = document.getElementById('powerUpIndicator');
            powerUpIndicator.textContent = message;
            powerUpIndicator.style.display = 'block';
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                powerUpIndicator.style.display = 'none';
            }, 4000);
        }

        function checkLevelUp() {
            const newLevel = Math.floor(playerScore / 500) + 1;
            if (newLevel > playerLevel) {
                playerLevel = newLevel;
                
                // Level up animation and reward (only 1 power-up per level)
                showPowerUpIndicator(`üéâ LEVEL UP! Welcome to Level ${playerLevel}! +1 Power-up! üéâ`);
                powerUps += 1; // Award 1 power-up for leveling up
                
                // Epic confetti for level up
                confetti({
                    particleCount: 200,
                    spread: 70,
                    origin: { y: 0.4 },
                    colors: ['#ff6b6b', '#ffd93d', '#6bcf7f', '#4ecdc4', '#45b7d1']
                });
                
                return true;
            }
            return false;
        }

        function handleCorrectAnswer() {
            // Calculate time bonus
            const timeBonusPoints = calculateTimeBonus();
            timeBonus = timeBonusPoints;
            totalTimeBonus += timeBonusPoints;
            
            // Base points for correct answer with difficulty multiplier
            let points = 100;
            
            // Difficulty bonus
            if (currentQuestionIndex < 25) {
                points = 100; // Beginner level
            } else if (currentQuestionIndex < 35) {
                points = 150; // Advanced level (+50% more points)
            } else {
                points = 200; // Expert level (+100% more points)
            }
            
            // Streak bonuses
            currentStreak++;
            correctAnswersInRow++;
            
            if (currentStreak > maxStreak) {
                maxStreak = currentStreak;
            }
            
            // Enhanced streak multipliers and power-up rewards
            // Only award power-ups once at specific streak milestones
            if (currentStreak === 15) {
                points += 300; // Master streak bonus
                powerUps += 1; // Award 1 power-up for reaching 15 streak
                showPowerUpIndicator('üèÜ MASTER STREAK! +300 Bonus Points + 1 Power-up! üèÜ');
            } else if (currentStreak === 10) {
                points += 200; // Epic streak bonus
                powerUps += 1; // Award 1 power-up for reaching 10 streak
                showPowerUpIndicator('üî• EPIC STREAK! +200 Bonus Points + 1 Power-up! üî•');
            } else if (currentStreak === 5) {
                points += 100; // Hot streak bonus
                powerUps += 1; // Award 1 power-up for reaching 5 streak
                showPowerUpIndicator('üî• HOT STREAK! +100 Bonus Points + 1 Power-up! üî•');
            } else if (currentStreak >= 3) {
                points += 50; // Good streak bonus (no power-up)
                showPowerUpIndicator(`üî• ${currentStreak} STREAK! +50 Bonus Points! üî•`);
            }
            
            // Remove time bonus power-ups (too frequent)
            if (timeBonusPoints > 0) {
                showPowerUpIndicator(`‚ö° SPEED BONUS! +${timeBonusPoints} Points! ‚ö°`);
            }
            
            // Remove milestone power-ups (too frequent)
            // Only show milestone achievements without power-ups
            if (playerScore % 500 === 0 && playerScore > 0) {
                showPowerUpIndicator('üéØ MILESTONE REACHED! Keep going!');
            }
            
            // Time bonus points
            points += timeBonusPoints;
            
            // Add points to total score
            playerScore += points;
            
            // Check for level up
            checkLevelUp();
            
            // Show streak indicator
            if (currentStreak >= 2) {
                showStreakIndicator();
            }
            
            // Enhanced confetti based on performance
            if (currentStreak >= 10) {
                // Epic rainbow confetti
                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.3 },
                    colors: ['#ff6b6b', '#ffd93d', '#6bcf7f', '#4ecdc4', '#45b7d1', '#a8e6cf']
                });
            } else if (currentStreak >= 5) {
                // Medium celebration
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.4 },
                    colors: ['#ffd93d', '#6bcf7f', '#45b7d1']
                });
            } else if (timeBonusPoints >= 30) {
                // Speed bonus confetti
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { y: 0.5 },
                    colors: ['#ff6b6b', '#ffd93d']
                });
            } else {
                // Basic celebration
                confetti({
                    particleCount: 50,
                    spread: 50,
                    origin: { y: 0.6 }
                });
            }
        }

        function startQuestionTimer() {
            questionStartTime = new Date();
        }

        function usePowerUp() {
            if (powerUps <= 0) {
                showPowerUpIndicator('‚ùå No power-ups available!');
                return;
            }
            
            // Use one power-up
            powerUps--;
            
            // Update both the sidebar and question-level power-up displays
            updatePowerUpDisplay();
            
            // Power-up effect: Eliminate two wrong answers
            const currentQuestionCard = document.querySelector('.question-card');
            if (!currentQuestionCard) return;
            
            const options = currentQuestionCard.querySelectorAll('.answer-option');
            const correctIndex = questions[currentQuestionIndex].correct;
            
            // Find incorrect options
            const incorrectOptions = [];
            options.forEach((option, index) => {
                if (index !== correctIndex) {
                    incorrectOptions.push({element: option, index: index});
                }
            });
            
            // Eliminate 2 random incorrect options
            if (incorrectOptions.length >= 2) {
                const shuffled = incorrectOptions.sort(() => 0.5 - Math.random());
                const toEliminate = shuffled.slice(0, 2);
                
                toEliminate.forEach(({element}) => {
                    element.style.opacity = '0.3';
                    element.style.background = 'linear-gradient(135deg, #f8d7da, #f5c6cb)';
                    element.style.border = '2px solid #dc3545';
                    element.style.pointerEvents = 'none';
                    element.style.transform = 'scale(0.95)';
                    
                    // Add elimination mark
                    const eliminationMark = document.createElement('div');
                    eliminationMark.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        font-size: 3rem;
                        color: #dc3545;
                        font-weight: bold;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                    `;
                    eliminationMark.textContent = '‚ùå';
                    element.style.position = 'relative';
                    element.appendChild(eliminationMark);
                });
                
                showPowerUpIndicator('üí• POWER-UP USED! Two wrong answers eliminated!');
                
                // Epic power-up confetti
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#ff9a9e', '#fecfef', '#ff6b6b']
                });
            } else {
                showPowerUpIndicator('‚ö†Ô∏è Power-up used but no wrong answers to eliminate!');
            }
            
            // Update game stats
            updateGameStats();
            
            // Save state
            saveQuizState();
        }

        // Function to update power-up display in both locations
        function updatePowerUpDisplay() {
            // Update sidebar power-up count
            const sidebarPowerUps = document.getElementById('powerUps');
            if (sidebarPowerUps) {
                sidebarPowerUps.textContent = powerUps;
            }
            
            // Update question-level power-up count and button
            const questionPowerUps = document.getElementById('questionPowerUps');
            const questionPowerUpBtn = document.getElementById('questionPowerUpBtn');
            
            if (questionPowerUps) {
                questionPowerUps.textContent = powerUps;
            }
            
            if (questionPowerUpBtn) {
                if (powerUps <= 0) {
                    questionPowerUpBtn.disabled = true;
                    questionPowerUpBtn.textContent = 'None';
                } else {
                    questionPowerUpBtn.disabled = false;
                    questionPowerUpBtn.textContent = 'Use';
                }
            }
        }

        // Make function globally accessible
        window.usePowerUp = usePowerUp;
        window.refreshLeaderboard = refreshLeaderboard;
        window.toggleLeaderboard = toggleLeaderboard;
        window.onPeriodChange = onPeriodChange;
        window.resetAllData = resetAllData;
        window.forceAllUsersFreshStart = forceAllUsersFreshStart;
        window.changePeriodForUser = changePeriodForUser;

        window.signOutUser = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        window.selectOption = function(selectedIndex) {
            const question = questions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct;
            
            // Store answer
            userAnswers[currentQuestionIndex] = {
                questionId: question.id,
                selectedIndex: selectedIndex,
                correct: isCorrect,
                timeSpent: new Date() - startTime
            };

            if (isCorrect) {
                score++;
                
                // Gamification for correct answers
                handleCorrectAnswer();
            } else {
                // Reset streak on wrong answer
                currentStreak = 0;
                correctAnswersInRow = 0;
                
                // Track wrong answer for second chance
                wrongAnswers.push({
                    questionIndex: currentQuestionIndex,
                    questionId: question.id,
                    question: question.question,
                    code: question.code,
                    options: question.options,
                    correct: question.correct,
                    explanation: question.explanation,
                    selectedIndex: selectedIndex,
                    difficulty: question.difficulty || 'beginner'
                });
            }

            // Update UI
            const options = document.querySelectorAll(`#options${currentQuestionIndex} .answer-option`);
            const selectedOption = options[selectedIndex];
            
            options.forEach((option, index) => {
                option.onclick = null; // Disable further clicks
                if (index === question.correct) {
                    option.classList.add('correct');
                    if (isCorrect) {
                        option.classList.add('correct-feedback');
                    }
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect');
                    option.classList.add('wrong-feedback');
                }
            });

            // Show feedback
            const feedback = document.getElementById(`feedback${currentQuestionIndex}`);
            feedback.innerHTML = `
                <strong>${isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect'}</strong><br>
                <strong>Explanation:</strong> ${question.explanation}
            `;
            feedback.classList.add('show');

            // Update game stats
            updateGameStats();

            // Save state after each answer
            saveQuizState();

            // Show next button with enhanced error handling
            const nextBtnId = `nextBtn${currentQuestionIndex}`;
            console.log('Looking for button with ID:', nextBtnId);
            
            let nextBtn = document.getElementById(nextBtnId);
            console.log('Button found:', nextBtn);
            
            // Try multiple approaches to find and show the button
            if (nextBtn) {
                nextBtn.style.display = 'inline-block';
                console.log('Button shown successfully');
            } else {
                console.error('Next button not found! ID:', nextBtnId);
                console.log('Available buttons in DOM:', Array.from(document.querySelectorAll('[id*="nextBtn"]')).map(btn => btn.id));
                
                // Fallback: try to find button by class and question container
                const questionCard = document.getElementById(`question${question.id}`);
                if (questionCard) {
                    const fallbackBtn = questionCard.querySelector('.next-btn');
                    if (fallbackBtn) {
                        fallbackBtn.style.display = 'inline-block';
                        console.log('Fallback button shown successfully');
                    } else {
                        console.error('No fallback button found either');
                    }
                } else {
                    console.error('Question card not found:', `question${question.id}`);
                }
            }
        };

        window.nextQuestion = function() {
            currentQuestionIndex++;
            
            // Save state after progressing to next question
            saveQuizState();
            
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
            } else {
                displayQuestion();
            }
        };

        window.restartQuiz = function() {
            // Reset all quiz variables
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            playerScore = 0;
            currentStreak = 0;
            maxStreak = 0;
            playerLevel = 1;
            achievements = [];
            correctAnswersInRow = 0;
            powerUps = 0; // Make sure power-ups start at 0
            timeBonus = 0;
            totalTimeBonus = 0;
            startTime = new Date();
            
            // Clear any saved state
            clearQuizState();
            
            showQuiz();
        };

        // Function to format code with professional Python syntax highlighting
        function formatPythonCode(code) {
            // Create a temporary element to let Prism.js handle the highlighting
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<pre><code class="language-python">${code}</code></pre>`;
            
            // Apply Prism.js highlighting
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(tempDiv);
                return tempDiv.innerHTML;
            } else {
                // Fallback if Prism.js isn't loaded yet
                return `<pre><code class="language-python">${code}</code></pre>`;
            }
        }

        // Quiz Questions Data
        const questions = [
            {
                id: 1,
                question: "What is the final value of the variable `a` after the following code block executes?",
                code: `def calculate_value(x):
    a = x + 10
    if a > 15:
        return 15
    a = a * 2
    return a

a = calculate_value(3)`,
                options: ["13", "26", "15", "3"],
                correct: 1,
                explanation: "calculate_value(3) sets a = 3 + 10 = 13. Since 13 is not > 15, we continue to a = 13 * 2 = 26, then return 26."
            },
            {
                id: 2,
                question: "What is the final value of the variable `a` after the following code block executes?",
                code: `def check_limit(val):
    val = val * 2
    if val > 30:
        return val // 3
    return val + 5

a = check_limit(10)`,
                options: ["15", "25", "6", "30"],
                correct: 1,
                explanation: "check_limit(10) sets val = 10 * 2 = 20. Since 20 is not > 30, we return 20 + 5 = 25."
            },
            {
                id: 3,
                question: "What is the final value of the variable `b` after the following code block executes?",
                code: `def adjust_price(price):
    if price < 50:
        return price + 5
    return price - 10

b = adjust_price(60)`,
                options: ["65", "45", "50", "60"],
                correct: 2,
                explanation: "adjust_price(60) checks if 60 < 50 (false), so we execute the else case: return 60 - 10 = 50."
            },
            {
                id: 4,
                question: "What is the final value of the variable `z` after the following code block executes?",
                code: `def power_up(base):
    total = base * 2
    return total

x = 5
y = power_up(x)
z = y + x`,
                options: ["10", "15", "5", "20"],
                correct: 1,
                explanation: "x = 5, y = power_up(5) = 5 * 2 = 10, z = y + x = 10 + 5 = 15."
            },
            {
                id: 5,
                question: "What is the final value of the variable `z` after the following code block executes?",
                code: `def calculate_discount(total):
    if total > 100:
        return 20
    if total > 50:
        return 10
    return 5

discount = calculate_discount(75)
z = 100 - discount`,
                options: ["80", "90", "95", "75"],
                correct: 1,
                explanation: "calculate_discount(75): 75 is not > 100, but 75 > 50, so return 10. z = 100 - 10 = 90."
            },
            {
                id: 6,
                question: "What is the final value of the variable `x` after the following code block executes?",
                code: `def modify_global(x):
    x = x + 10  # Local modification
    return x

x = 5
y = modify_global(x)
# The value of the global variable x is then printed.
print(x)`,
                options: ["15", "10", "5", "0"],
                correct: 2,
                explanation: "The function modifies a local parameter x, not the global variable. Global x remains 5."
            },
            {
                id: 7,
                question: "What is the final value of the variable `total` after the following code block executes?",
                code: `def final_check(value):
    value = value * 2
    if value > 20:
        return value
    else:
        value = value + 1
    return value

total = final_check(11)`,
                options: ["23", "22", "11", "12"],
                correct: 1,
                explanation: "final_check(11): value = 11 * 2 = 22. Since 22 > 20 is true, we return 22 immediately."
            },
            {
                id: 8,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def process_number(num):
    if num % 2 == 0:
        return num / 2
    return num * 3 + 1

result = process_number(8)`,
                options: ["25", "8", "16", "4"],
                correct: 3,
                explanation: "process_number(8): Since 8 % 2 == 0 (8 is even), we return 8 / 2 = 4."
            },
            {
                id: 9,
                question: "What is the final value of the variable `output` after the following code block executes?",
                code: `def chain_operations(x):
    x = x + 5
    if x > 10:
        x = x - 3
    return x * 2

output = chain_operations(7)`,
                options: ["24", "18", "14", "20"],
                correct: 1,
                explanation: "chain_operations(7): x = 7 + 5 = 12. Since 12 > 10, x = 12 - 3 = 9. Return 9 * 2 = 18."
            },
            {
                id: 10,
                question: "What is the final value of the variable `answer` after the following code block executes?",
                code: `def nested_logic(a, b):
    if a > b:
        if a > 10:
            return a + b
        return a - b
    return b - a

answer = nested_logic(12, 8)`,
                options: ["4", "-4", "20", "12"],
                correct: 2,
                explanation: "nested_logic(12, 8): 12 > 8 (true), then 12 > 10 (true), so return 12 + 8 = 20."
            },
            {
                id: 11,
                question: "What is the final value of the variable `val` after the following code block executes?",
                code: `def calculate_grade(score):
    if score >= 90:
        return "A"
    elif score >= 80:
        return "B"
    elif score >= 70:
        return "C"
    return "F"

grade = calculate_grade(85)
val = len(grade)`,
                options: ["2", "1", "85", "80"],
                correct: 1,
                explanation: "calculate_grade(85): 85 >= 80 (true), so return 'B'. val = len('B') = 1."
            },
            {
                id: 12,
                question: "What is the final value of the variable `count` after the following code block executes?",
                code: `def count_operations(start):
    count = 0
    while start > 1:
        start = start // 2
        count += 1
    return count

count = count_operations(16)`,
                options: ["3", "5", "16", "4"],
                correct: 3,
                explanation: "count_operations(16): 16->8 (count=1), 8->4 (count=2), 4->2 (count=3), 2->1 (count=4). Return 4."
            },
            {
                id: 13,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def mystery_function(x, y):
    if x == y:
        return x + y
    elif x > y:
        return x - y
    else:
        return y - x

result = mystery_function(5, 8)`,
                options: ["13", "3", "-3", "5"],
                correct: 1,
                explanation: "mystery_function(5, 8): 5 != 8, 5 not > 8, so else clause: return 8 - 5 = 3."
            },
            {
                id: 14,
                question: "What is the final value of the variable `output` after the following code block executes?",
                code: `def transform_value(n):
    if n < 0:
        return abs(n)
    elif n == 0:
        return 1
    return n * n

output = transform_value(-4)`,
                options: ["16", "-4", "4", "1"],
                correct: 2,
                explanation: "transform_value(-4): Since -4 < 0, return abs(-4) = 4."
            },
            {
                id: 15,
                question: "What is the final value of the variable `final_val` after the following code block executes?",
                code: `def sequence_ops(num):
    num = num + 2
    num = num * 3
    if num > 20:
        num = num - 5
    return num

final_val = sequence_ops(4)`,
                options: ["23", "15", "13", "18"],
                correct: 3,
                explanation: "sequence_ops(4): num = 4 + 2 = 6, num = 6 * 3 = 18. Since 18 not > 20, return 18."
            },
            {
                id: 16,
                question: "What is the final value of the variable `score` after the following code block executes?",
                code: `def game_logic(points, bonus):
    total = points + bonus
    if total >= 100:
        return total + 50
    elif total >= 50:
        return total + 25
    return total + 10

score = game_logic(60, 30)`,
                options: ["100", "90", "115", "140"],
                correct: 2,
                explanation: "game_logic(60, 30): total = 60 + 30 = 90. Since 90 >= 100 is false, but 90 >= 50 is true, return 90 + 25 = 115."
            },
            {
                id: 17,
                question: "What is the final value of the variable `end_result` after the following code block executes?",
                code: `def complex_calc(a, b, c):
    if a > b and b > c:
        return a + b + c
    elif a > c:
        return a - c
    return c - a

end_result = complex_calc(10, 5, 3)`,
                options: ["7", "18", "-7", "10"],
                correct: 1,
                explanation: "complex_calc(10, 5, 3): Check if 10 > 5 and 5 > 3 (both true), so return 10 + 5 + 3 = 18."
            },
            {
                id: 18,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def validate_input(value):
    if value is None:
        return 0
    elif isinstance(value, str):
        return len(value)
    elif isinstance(value, int):
        return value * 2
    return -1

result = validate_input("Hello")`,
                options: ["0", "10", "5", "-1"],
                correct: 2,
                explanation: "validate_input('Hello'): value is not None, value is a string, so return len('Hello') = 5."
            },
            {
                id: 19,
                question: "What is the final value of the variable `computed` after the following code block executes?",
                code: `def recursive_like(n):
    if n <= 1:
        return 1
    return n + recursive_like(n - 1)

computed = recursive_like(3)`,
                options: ["3", "4", "1", "6"],
                correct: 3,
                explanation: "recursive_like(3): 3 + recursive_like(2) = 3 + (2 + recursive_like(1)) = 3 + (2 + 1) = 6."
            },
            {
                id: 20,
                question: "What is the final value of the variable `status` after the following code block executes?",
                code: `def check_status(age, has_license):
    if age >= 18 and has_license:
        return "Can Drive"
    elif age >= 16:
        return "Learner"
    return "Too Young"

status = check_status(17, False)`,
                options: ["Can Drive", "Learner", "Too Young", "False"],
                correct: 1,
                explanation: "check_status(17, False): 17 >= 18 and False evaluates to False, but 17 >= 16 is True, so return 'Learner'."
            },
            {
                id: 21,
                question: "What is the final value of the variable `outcome` after the following code block executes?",
                code: `def logic_gates(x, y, z):
    if x and y:
        return z
    elif x or y:
        return not z
    return x

outcome = logic_gates(True, False, True)`,
                options: ["True", "None", "False", "1"],
                correct: 2,
                explanation: "logic_gates(True, False, True): True and False = False, but True or False = True, so return not True = False."
            },
            {
                id: 22,
                question: "What is the final value of the variable `final` after the following code block executes?",
                code: `def string_ops(text):
    if len(text) == 0:
        return "Empty"
    elif len(text) < 5:
        return text.upper()
    return text.lower()

final = string_ops("Code")`,
                options: ["code", "Empty", "Code", "CODE"],
                correct: 3,
                explanation: "string_ops('Code'): len('Code') = 4, which is not 0 and is < 5, so return 'Code'.upper() = 'CODE'."
            },
            {
                id: 23,
                question: "What is the final value of the variable `amount` after the following code block executes?",
                code: `def calculate_tax(income, rate):
    tax = income * rate
    if tax > 1000:
        tax = tax * 0.9  # 10% reduction
    return round(tax, 2)

amount = calculate_tax(5000, 0.25)`,
                options: ["1250.0", "1125.0", "1000.0", "900.0"],
                correct: 1,
                explanation: "calculate_tax(5000, 0.25): tax = 5000 * 0.25 = 1250. Since 1250 > 1000, tax = 1250 * 0.9 = 1125. Return round(1125, 2) = 1125.0."
            },
            {
                id: 24,
                question: "What is the final value of the variable `response` after the following code block executes?",
                code: `def categorize_number(num):
    categories = []
    if num % 2 == 0:
        categories.append("even")
    else:
        categories.append("odd")
    
    if num > 0:
        categories.append("positive")
    elif num < 0:
        categories.append("negative")
    
    return len(categories)

response = categorize_number(-6)`,
                options: ["1", "3", "2", "0"],
                correct: 2,
                explanation: "categorize_number(-6): -6 % 2 == 0 (even), so append 'even'. -6 < 0, so append 'negative'. categories = ['even', 'negative'], len = 2."
            },
            {
                id: 25,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def fibonacci_check(n):
    a, b = 0, 1
    while b < n:
        a, b = b, a + b
    return b == n

def process_fib(num):
    if fibonacci_check(num):
        return num * 2
    return num + 1

result = process_fib(8)`,
                options: ["9", "8", "1", "16"],
                correct: 3,
                explanation: "fibonacci_check(8): sequence 0,1,1,2,3,5,8,13... 8 is in fibonacci, so return True. process_fib(8): True condition, so return 8 * 2 = 16."
            },
            
            // LEVEL 2: ADVANCED CONCEPTS (Questions 26-35)
            {
                question: "What will this function with nested calls output?",
                code: `def multiply_by_two(x):
    return x * 2

def add_five(x):
    return x + 5

def process_data(num):
    step1 = multiply_by_two(num)
    step2 = add_five(step1)
    step3 = multiply_by_two(step2)
    return step3

result = process_data(3)`,
                options: ["22", "16", "11", "13"],
                correct: 0,
                explanation: "process_data(3): step1 = 3*2 = 6, step2 = 6+5 = 11, step3 = 11*2 = 22."
            },
            {
                question: "What does this recursive function return?",
                code: `def countdown(n):
    if n <= 0:
        return "Done"
    print(f"Count: {n}")
    return countdown(n - 1)

result = countdown(3)`,
                options: ["Done", "Count: 1", "3", "None"],
                correct: 0,
                explanation: "countdown(3) prints 'Count: 3', then countdown(2) prints 'Count: 2', then countdown(1) prints 'Count: 1', then countdown(0) returns 'Done'."
            },
            {
                question: "What will this function with list manipulation return?",
                code: `def process_list(numbers):
    result = []
    for num in numbers:
        if num % 2 == 0:
            result.append(num * 2)
        else:
            result.append(num + 1)
    return sum(result)

output = process_list([1, 2, 3, 4])`,
                options: ["20", "16", "18", "14"],
                correct: 2,
                explanation: "process_list([1,2,3,4]): 1 is odd‚Üí2, 2 is even‚Üí4, 3 is odd‚Üí4, 4 is even‚Üí8. result=[2,4,4,8], sum=18."
            },
            {
                question: "What does this function with dictionary operations return?",
                code: `def count_chars(text):
    counts = {}
    for char in text:
        if char in counts:
            counts[char] += 1
        else:
            counts[char] = 1
    return counts['o']

result = count_chars("hello world")`,
                options: ["2", "1", "3", "0"],
                correct: 0,
                explanation: "count_chars('hello world'): counts 'o' appears twice (in 'hello' and 'world'), so counts['o'] = 2."
            },
            {
                question: "What will this function with string slicing return?",
                code: `def reverse_words(sentence):
    words = sentence.split()
    reversed_words = []
    for word in words:
        reversed_words.append(word[::-1])
    return ' '.join(reversed_words)

result = reverse_words("hello world")`,
                options: ["olleh dlrow", "world hello", "dlrow olleh", "hello world"],
                correct: 0,
                explanation: "reverse_words('hello world'): splits into ['hello','world'], reverses each: ['olleh','dlrow'], joins with space: 'olleh dlrow'."
            },
            {
                question: "What does this function with nested loops output?",
                code: `def pattern_sum():
    total = 0
    for i in range(1, 4):
        for j in range(1, i + 1):
            total += i * j
    return total

result = pattern_sum()`,
                options: ["20", "14", "18", "16"],
                correct: 0,
                explanation: "pattern_sum(): i=1: j=1, total+=1*1=1. i=2: j=1,2, total+=2*1+2*2=7. i=3: j=1,2,3, total+=3*1+3*2+3*3=25. Final total=20."
            },
            {
                question: "What will this function with exception handling return?",
                code: `def safe_divide(a, b):
    try:
        result = a / b
        return int(result)
    except ZeroDivisionError:
        return -1
    except:
        return 0

output = safe_divide(10, 3)`,
                options: ["3", "3.33", "-1", "0"],
                correct: 0,
                explanation: "safe_divide(10, 3): 10/3 = 3.333..., int(3.333) = 3. No exception occurs, so return 3."
            },
            {
                question: "What does this function with lambda and map return?",
                code: `def transform_numbers(nums):
    doubled = list(map(lambda x: x * 2, nums))
    filtered = [x for x in doubled if x > 5]
    return len(filtered)

result = transform_numbers([1, 2, 3, 4, 5])`,
                options: ["3", "2", "4", "5"],
                correct: 0,
                explanation: "transform_numbers([1,2,3,4,5]): doubled=[2,4,6,8,10], filtered=[6,8,10] (>5), len=3."
            },
            {
                question: "What will this function with class methods return?",
                code: `class Calculator:
    def __init__(self, start=0):
        self.value = start
    
    def add(self, num):
        self.value += num
        return self
    
    def multiply(self, num):
        self.value *= num
        return self

calc = Calculator(5).add(3).multiply(2)
result = calc.value`,
                options: ["16", "13", "11", "10"],
                correct: 0,
                explanation: "Calculator(5): value=5. add(3): value=5+3=8. multiply(2): value=8*2=16. Final value=16."
            },
            {
                question: "What does this function with generator return?",
                code: `def number_generator(n):
    for i in range(n):
        yield i * 2

def sum_generated(limit):
    total = 0
    for num in number_generator(limit):
        if num < 6:
            total += num
    return total

result = sum_generated(4)`,
                options: ["6", "8", "4", "10"],
                correct: 0,
                explanation: "sum_generated(4): generator yields 0,2,4,6. Numbers < 6 are 0,2,4. sum = 0+2+4 = 6."
            },
            
            // LEVEL 3: EXPERT CONCEPTS (Questions 36-45)
            {
                question: "What will this advanced function with closures return?",
                code: `def create_multiplier(factor):
    def multiply(x):
        return x * factor
    return multiply

times_three = create_multiplier(3)
times_five = create_multiplier(5)

result = times_three(4) + times_five(2)`,
                options: ["22", "20", "15", "12"],
                correct: 0,
                explanation: "create_multiplier creates closures. times_three(4) = 4*3 = 12, times_five(2) = 2*5 = 10. result = 12+10 = 22."
            },
            {
                question: "What does this function with decorators output?",
                code: `def double_result(func):
    def wrapper(*args):
        result = func(*args)
        return result * 2
    return wrapper

@double_result
def add_numbers(a, b):
    return a + b

output = add_numbers(3, 4)`,
                options: ["14", "7", "12", "8"],
                correct: 0,
                explanation: "add_numbers(3,4) with @double_result: first calculates 3+4=7, then doubles it: 7*2=14."
            },
            {
                question: "What will this function with complex data structures return?",
                code: `def process_nested_data(data):
    result = {}
    for key, values in data.items():
        total = sum([v for v in values if v % 2 == 0])
        result[key] = total
    return result['B']

data = {'A': [1,2,3,4], 'B': [2,4,6,8], 'C': [1,3,5]}
output = process_nested_data(data)`,
                options: ["20", "10", "15", "8"],
                correct: 0,
                explanation: "process_nested_data: for 'B':[2,4,6,8], even numbers are all of them. sum([2,4,6,8]) = 20."
            },
            {
                question: "What does this function with advanced list comprehension return?",
                code: `def matrix_sum(matrix):
    flattened = [num for row in matrix for num in row if num > 0]
    squares = [x**2 for x in flattened if x % 2 != 0]
    return sum(squares)

matrix = [[1,-2,3], [4,0,-1], [2,5,6]]
result = matrix_sum(matrix)`,
                options: ["35", "25", "10", "45"],
                correct: 0,
                explanation: "matrix_sum: flattened positive numbers [1,3,4,2,5,6], odd ones [1,3,5], squares [1,9,25], sum = 1+9+25 = 35."
            },
            {
                question: "What will this function with multiple inheritance return?",
                code: `class A:
    def method(self):
        return 10

class B:
    def method(self):
        return 20

class C(A, B):
    def get_value(self):
        return self.method() + 5

obj = C()
result = obj.get_value()`,
                options: ["15", "25", "30", "35"],
                correct: 0,
                explanation: "Multiple inheritance: C inherits from A first, so method() returns 10. get_value() = 10 + 5 = 15."
            },
            {
                question: "What does this function with context managers return?",
                code: `class Counter:
    def __init__(self):
        self.count = 0
    
    def __enter__(self):
        self.count += 1
        return self
    
    def __exit__(self, *args):
        self.count += 2

counter = Counter()
with counter as c:
    c.count += 3

result = counter.count`,
                options: ["6", "4", "3", "5"],
                correct: 0,
                explanation: "__enter__ adds 1 (count=1), inside context adds 3 (count=4), __exit__ adds 2 (count=6). Final result=6."
            },
            {
                question: "What will this function with metaclasses return?",
                code: `class Meta(type):
    def __new__(cls, name, bases, attrs):
        attrs['class_id'] = len(name)
        return super().__new__(cls, name, bases, attrs)

class TestClass(metaclass=Meta):
    value = 10

obj = TestClass()
result = obj.class_id + obj.value`,
                options: ["19", "15", "20", "10"],
                correct: 0,
                explanation: "Metaclass adds class_id = len('TestClass') = 9. result = 9 + 10 = 19."
            },
            {
                question: "What does this function with advanced generators return?",
                code: `def fibonacci_gen():
    a, b = 0, 1
    while True:
        yield a
        a, b = b, a + b

def nth_fibonacci(n):
    gen = fibonacci_gen()
    for i in range(n):
        result = next(gen)
    return result

output = nth_fibonacci(6)`,
                options: ["5", "8", "3", "13"],
                correct: 0,
                explanation: "nth_fibonacci(6): generates 0,1,1,2,3,5... The 6th number (0-indexed) is 5."
            },
            {
                question: "What will this function with async/await simulation return?",
                code: `def simulate_async():
    results = []
    
    def task1():
        return [1, 2, 3]
    
    def task2():
        return [4, 5, 6]
    
    results.extend(task1())
    results.extend(task2())
    return sum(results[::2])

result = simulate_async()`,
                options: ["9", "21", "12", "15"],
                correct: 0,
                explanation: "simulate_async: results=[1,2,3,4,5,6], results[::2]=[1,3,5] (every 2nd), sum=1+3+5=9."
            },
            {
                question: "What does this function with advanced algorithms return?",
                code: `def binary_search_modified(arr, target):
    left, right = 0, len(arr) - 1
    count = 0
    
    while left <= right:
        count += 1
        mid = (left + right) // 2
        if arr[mid] == target:
            return count
        elif arr[mid] < target:
            left = mid + 1
        else:
            right = mid - 1
    return count

result = binary_search_modified([1,2,3,4,5,6,7,8], 6)`,
                options: ["3", "2", "4", "1"],
                correct: 0,
                explanation: "binary_search_modified for 6 in [1,2,3,4,5,6,7,8]: mid=3.5‚Üí3(val=4)<6, left=4. mid=5.5‚Üí5(val=6)=6. Found in 3 steps."
            }
        ];

        // Update quiz info to reflect new total
        function updateQuizInfo() {
            const quizInfoElement = document.querySelector('.quiz-info strong');
            if (quizInfoElement) {
                quizInfoElement.textContent = `${questions.length} Epic Challenges ‚Ä¢ Master Python Functions`;
            }
        }

        // Quiz state variables
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let wrongAnswers = []; // Track questions that need second chance
        let score = 0;
        let startTime = null;
        let currentUserPeriod = null;

        // Admin configuration
        const ADMIN_EMAIL = 'morais.irving@isd622.org'; // Your admin email
        let isAdmin = false;

        // Gamification variables
        let playerScore = 0;
        let currentStreak = 0;
        let maxStreak = 0;
        let playerLevel = 1;
        let achievements = [];
        let correctAnswersInRow = 0;
        let powerUps = 0;
        let timeBonus = 0;
        let questionStartTime = null;
        let totalTimeBonus = 0;

        // State persistence functions
        function saveQuizState() {
            if (!currentUser) return;
            
            const quizState = {
                currentQuestionIndex,
                userAnswers,
                score,
                startTime: startTime ? startTime.getTime() : null,
                playerScore,
                currentStreak,
                maxStreak,
                playerLevel,
                achievements,
                correctAnswersInRow,
                powerUps,
                timeBonus,
                totalTimeBonus,
                lastSaved: new Date().getTime()
            };
            
            localStorage.setItem(`quizState_${currentUser.uid}`, JSON.stringify(quizState));
        }

        function loadQuizState() {
            if (!currentUser) return false;
            
            const savedState = localStorage.getItem(`quizState_${currentUser.uid}`);
            if (!savedState) return false;
            
            try {
                const state = JSON.parse(savedState);
                
                // Check if state is recent (within 24 hours)
                const now = new Date().getTime();
                if (now - state.lastSaved > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(`quizState_${currentUser.uid}`);
                    return false;
                }
                
                // Restore state
                currentQuestionIndex = state.currentQuestionIndex || 0;
                userAnswers = state.userAnswers || [];
                score = state.score || 0;
                startTime = state.startTime ? new Date(state.startTime) : new Date();
                playerScore = state.playerScore || 0;
                currentStreak = state.currentStreak || 0;
                maxStreak = state.maxStreak || 0;
                playerLevel = state.playerLevel || 1;
                achievements = state.achievements || [];
                correctAnswersInRow = state.correctAnswersInRow || 0;
                powerUps = state.powerUps || 0;
                timeBonus = state.timeBonus || 0;
                totalTimeBonus = state.totalTimeBonus || 0;
                
                return true;
            } catch (error) {
                console.error('Error loading quiz state:', error);
                localStorage.removeItem(`quizState_${currentUser.uid}`);
                return false;
            }
        }

        function clearQuizState() {
            if (!currentUser) return;
            localStorage.removeItem(`quizState_${currentUser.uid}`);
        }

        function restartQuiz() {
            // Clear saved state
            clearQuizState();
            
            // Reset all variables
            currentQuestionIndex = 0;
            userAnswers = [];
            wrongAnswers = [];
            score = 0;
            playerScore = 0;
            currentStreak = 0;
            maxStreak = 0;
            playerLevel = 1;
            achievements = [];
            correctAnswersInRow = 0;
            startTime = new Date();
            
            // Show quiz section
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('gameStats').style.display = 'flex';
            
            // Update game stats and display first question
            updateGameStats();
            displayQuestion();
            
            // Save initial state
            saveQuizState();
        }

        // Make restartQuiz globally available
        window.restartQuiz = restartQuiz;
        window.startSecondChance = startSecondChance;

        // Emergency recovery functions for stuck students
        function checkForStuckStudents() {
            // Check if student has answered current question but button is missing
            const currentQuestionCard = document.querySelector('.question-card');
            if (!currentQuestionCard) return;

            const hasAnswered = currentQuestionCard.querySelector('.option.correct, .option.incorrect');
            const nextButton = currentQuestionCard.querySelector('.next-btn[style*="inline-block"], .next-btn:not([style*="none"])');
            
            console.log('Emergency check - Has answered:', !!hasAnswered, 'Next button visible:', !!nextButton);

            if (hasAnswered && !nextButton) {
                console.log('STUCK STUDENT DETECTED! Initiating emergency recovery...');
                showEmergencyHelp();
            }
        }

        function showEmergencyHelp() {
            // Create emergency help overlay
            const emergencyOverlay = document.createElement('div');
            emergencyOverlay.id = 'emergencyHelp';
            emergencyOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: Arial, sans-serif;
            `;
            
            emergencyOverlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 500px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <h2 style="color: #e74c3c; margin-bottom: 20px;">üö® We're Here to Help!</h2>
                    <p style="font-size: 16px; margin-bottom: 30px; color: #333;">
                        It looks like you answered a question but the Next button didn't appear. 
                        Don't worry - we can fix this right away!
                    </p>
                    <button onclick="emergencyRecovery()" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        margin-right: 15px;
                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                    ">
                        üîß Fix & Continue Quiz
                    </button>
                    <button onclick="closeEmergencyHelp()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 16px;
                        cursor: pointer;
                    ">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(emergencyOverlay);
        }

        function emergencyRecovery() {
            console.log('Executing emergency recovery...');
            
            // Force show next button using multiple methods
            const currentQuestionCard = document.querySelector('.question-card');
            if (currentQuestionCard) {
                // Method 1: Find any hidden next button and show it
                const hiddenButtons = currentQuestionCard.querySelectorAll('.next-btn');
                hiddenButtons.forEach(btn => {
                    btn.style.display = 'inline-block';
                    btn.style.visibility = 'visible';
                });

                // Method 2: Create new next button if none exists
                if (hiddenButtons.length === 0) {
                    const newButton = document.createElement('button');
                    newButton.className = 'next-btn';
                    newButton.style.cssText = `
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        margin-top: 20px;
                        display: inline-block;
                    `;
                    newButton.innerHTML = currentQuestionIndex === questions.length - 1 ? 'Finish Quiz ‚Üí' : 'Next Question ‚Üí';
                    newButton.onclick = () => window.nextQuestion();
                    currentQuestionCard.appendChild(newButton);
                }
            }

            // Close emergency help
            closeEmergencyHelp();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 1000;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            `;
            successMsg.textContent = '‚úÖ Fixed! You can now continue the quiz.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 4000);
        }

        function closeEmergencyHelp() {
            const overlay = document.getElementById('emergencyHelp');
            if (overlay) {
                overlay.parentNode.removeChild(overlay);
            }
        }

        // Make emergency functions globally available
        window.showEmergencyHelp = showEmergencyHelp;
        window.emergencyRecovery = emergencyRecovery;
        window.closeEmergencyHelp = closeEmergencyHelp;

        // Initialize Firebase Auth after Firebase is loaded
        window.addEventListener('load', async () => {
            await initFirebase();
            
            // Update quiz info with current question count
            updateQuizInfo();
            
            // Set up authentication listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showQuiz();
                } else {
                    showLogin();
                }
            });
        });

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('gameStats').style.display = 'none';
            document.getElementById('leaderboardSection').style.display = 'none';
        }

        function showQuiz() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('gameStats').style.display = 'flex';
            document.getElementById('leaderboardSection').style.display = 'block';
            
            // Check if user is admin
            isAdmin = currentUser.email === ADMIN_EMAIL;
            
            // Check if user has a saved period first
            const savedPeriod = localStorage.getItem(`userPeriod_${currentUser.uid}`);
            
            // Display user info with admin controls
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <img src="${currentUser.photoURL}" alt="Profile" class="user-avatar">
                <div>
                    <strong>${currentUser.displayName}</strong><br>
                    <span style="color: #6c757d;">${currentUser.email}</span>
                    ${savedPeriod ? `<br><span style="color: #667eea; font-weight: bold;">üìö Period ${savedPeriod}</span>` : ''}
                    ${isAdmin ? `<br><span style="color: #dc3545; font-weight: bold;">üîß ADMIN</span>` : ''}
                </div>
                <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                    ${isAdmin ? `
                        <button class="admin-btn" onclick="resetAllData()" title="Reset all quiz data">
                            üóëÔ∏è Reset Data
                        </button>
                        <button class="admin-btn" onclick="forceAllUsersFreshStart()" title="Clear all saved quiz states">
                            üîÑ Force Fresh Start
                        </button>
                        <button class="admin-btn" onclick="changePeriodForUser()" title="Change user period">
                            üìö Change Period
                        </button>
                    ` : `
                        <button class="period-change-btn" onclick="changePeriodForUser()" title="Change your period">
                            üìö Change Period
                        </button>
                    `}
                    <button class="logout-btn" onclick="window.signOutUser()">Sign Out</button>
                </div>
            `;

            // Set up period selection
            if (savedPeriod) {
                document.getElementById('periodSelect').value = savedPeriod;
                currentUserPeriod = savedPeriod;
                loadLeaderboard();
                document.getElementById('refreshBtn').style.display = 'block';
            } else {
                // Show period selection prompt
                showPeriodSelectionPrompt();
            }

            // Force fresh start for all users to fix power-up issue
            const stateRestored = false; // Temporarily disable state restoration
            
            if (!stateRestored) {
                // Initialize new quiz - ensure power-ups start at 0
                currentQuestionIndex = 0;
                userAnswers = [];
                wrongAnswers = [];
                score = 0;
                playerScore = 0;
                currentStreak = 0;
                maxStreak = 0;
                playerLevel = 1;
                achievements = [];
                correctAnswersInRow = 0;
                powerUps = 0; // Force power-ups to start at 0
                timeBonus = 0;
                totalTimeBonus = 0;
                startTime = new Date();
            } else {
                // Show continuation message
                if (currentQuestionIndex > 0) {
                    const continueMessage = document.createElement('div');
                    continueMessage.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(45deg, #4CAF50, #45a049);
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        z-index: 1000;
                        font-weight: bold;
                    `;
                    continueMessage.innerHTML = `üîÑ Continuing from Question ${currentQuestionIndex + 1}`;
                    document.body.appendChild(continueMessage);
                    
                    setTimeout(() => {
                        if (continueMessage.parentNode) {
                            continueMessage.parentNode.removeChild(continueMessage);
                        }
                    }, 3000);
                }
            }

            // Update game stats
            updateGameStats();

            // Display current question
            displayQuestion();
            
            // Initialize leaderboard collapse state
            const isCollapsed = localStorage.getItem('leaderboardCollapsed') === 'true';
            const wrapper = document.getElementById('leaderboardContentWrapper');
            const button = document.getElementById('leaderboardToggle');
            
            if (wrapper && button && isCollapsed) {
                wrapper.classList.add('collapsed');
                button.classList.add('collapsed');
                button.textContent = '‚ñ∂';
            }
            
            // Save state after showing quiz
            saveQuizState();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            const questionsContainer = document.getElementById('quizQuestions');
            
            if (!questionsContainer) {
                console.error('quizQuestions container not found!');
                return;
            }
            
            // Determine difficulty level
            let difficultyInfo = '';
            let difficultyClass = '';
            if (currentQuestionIndex < 25) {
                difficultyInfo = 'üü¢ BEGINNER';
                difficultyClass = 'difficulty-beginner';
            } else if (currentQuestionIndex < 35) {
                difficultyInfo = 'üü° ADVANCED';
                difficultyClass = 'difficulty-advanced';
            } else {
                difficultyInfo = 'üî¥ EXPERT';
                difficultyClass = 'difficulty-expert';
            }
            
            // Start timer for this question
            startQuestionTimer();
            
            // Update progress
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            questionsContainer.innerHTML = `
                <div class="question-card ${difficultyClass}" id="question${currentQuestionIndex}">
                    <div class="question-header">
                        <div class="question-number">${currentQuestionIndex + 1}</div>
                        <div class="difficulty-badge">${difficultyInfo}</div>
                        <div class="question-text">${question.question}</div>
                    </div>
                    <div class="code-block">
                        <pre><code class="language-python">${question.code}</code></pre>
                    </div>
                    
                    <div class="question-content-wrapper">
                        <div class="options-container" id="options${currentQuestionIndex}">
                            ${question.options.map((option, index) => `
                                <div class="answer-option" onclick="selectOption(${index})" id="option${currentQuestionIndex}_${index}">
                                    <strong>${String.fromCharCode(65 + index)}.</strong> ${option}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="question-powerups">
                            <div class="powerup-section">
                                <h4>üåü Power-ups</h4>
                                <div class="powerup-item">
                                    <span class="powerup-icon">‚ùå</span>
                                    <span class="powerup-count" id="questionPowerUps">${powerUps}</span>
                                    <button class="powerup-use-btn" onclick="usePowerUp('elimination')" id="questionPowerUpBtn" ${powerUps <= 0 ? 'disabled' : ''}>
                                        ${powerUps <= 0 ? 'None' : 'Use'}
                                    </button>
                                </div>
                                <div class="powerup-help">
                                    üí° Eliminate wrong answers
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="feedback" id="feedback${currentQuestionIndex}"></div>
                    <button class="next-btn" id="nextBtn${currentQuestionIndex}" onclick="nextQuestion()">
                        ${currentQuestionIndex === questions.length - 1 ? 'üèÅ Finish Quiz' : 'Next Question ‚Üí'}
                    </button>
                </div>
            `;

            // Apply Prism.js highlighting after DOM insertion
            setTimeout(() => {
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
                // Update power-up display after question is rendered
                updatePowerUpDisplay();
            }, 10);

            // Emergency recovery for stuck students
            setTimeout(() => {
                checkForStuckStudents();
            }, 500);
        }

        function finishQuiz() {
            const endTime = new Date();
            const totalTime = Math.round((endTime - startTime) / 1000); // seconds
            
            // Calculate detailed stats
            const correctAnswers = userAnswers.filter(answer => answer.correct).length;
            const percentage = Math.round((correctAnswers / questions.length) * 100);
            
            // Save to Firebase with detailed user data and gamification stats
            saveQuizResults({
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userEmail: currentUser.email,
                userPhoto: currentUser.photoURL,
                period: currentUserPeriod,
                score: correctAnswers,
                totalQuestions: questions.length,
                percentage: percentage,
                timeSpent: totalTime,
                answers: userAnswers,
                completedAt: serverTimestamp(),
                // Gamification data
                finalScore: playerScore,
                maxStreak: Math.max(maxStreak, currentStreak),
                achievements: achievements,
                level: playerLevel,
                totalCorrectAnswers: correctAnswers,
                // Detailed answer breakdown for teacher analysis
                answerDetails: userAnswers.map((answer, index) => ({
                    questionNumber: index + 1,
                    questionId: answer.questionId,
                    questionText: questions[index].question,
                    userAnswer: questions[index].options[answer.selectedIndex],
                    correctAnswer: questions[index].options[questions[index].correct],
                    isCorrect: answer.correct,
                    timeSpent: answer.timeSpent,
                    explanation: questions[index].explanation
                }))
            });

            // Show results
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            document.getElementById('scoreDisplay').innerHTML = `${correctAnswers}/${questions.length}`;
            
            // Performance message
            let performanceMsg = '';
            let performanceColor = '';
            
            if (percentage >= 90) {
                performanceMsg = 'üèÜ Outstanding! Excellent mastery of execution tracing!';
                performanceColor = '#28a745';
            } else if (percentage >= 80) {
                performanceMsg = 'üåü Great job! Very good understanding!';
                performanceColor = '#17a2b8';
            } else if (percentage >= 70) {
                performanceMsg = 'üëç Good work! Keep practicing!';
                performanceColor = '#ffc107';
            } else {
                performanceMsg = 'üìö Keep studying! Review the concepts and try again!';
                performanceColor = '#dc3545';
            }

            document.getElementById('scoreBreakdown').innerHTML = `
                <div class="score-item">
                    <h3>Score</h3>
                    <div style="font-size: 2rem; color: ${performanceColor};">${percentage}%</div>
                </div>
                <div class="score-item">
                    <h3>Correct Answers</h3>
                    <div style="font-size: 2rem; color: #28a745;">${correctAnswers}</div>
                </div>
                <div class="score-item">
                    <h3>Time Spent</h3>
                    <div style="font-size: 2rem; color: #6c757d;">${Math.floor(totalTime / 60)}:${(totalTime % 60).toString().padStart(2, '0')}</div>
                </div>
                <div class="score-item" style="grid-column: 1/-1;">
                    <h3 style="color: ${performanceColor};">${performanceMsg}</h3>
                </div>
            `;
            
            // Show Second Chance option if there are wrong answers
            const secondChanceSection = document.getElementById('secondChanceSection');
            const wrongCountSpan = document.getElementById('wrongCount');
            
            if (wrongAnswers.length > 0) {
                wrongCountSpan.textContent = wrongAnswers.length;
                secondChanceSection.style.display = 'block';
            } else {
                secondChanceSection.style.display = 'none';
            }
            
            // Clear saved state since quiz is completed
            clearQuizState();
            
            // Refresh leaderboard to show updated rankings
            refreshLeaderboard();
        }

        // Second Chance Mode Variables
        let isSecondChanceMode = false;
        let secondChanceQuestions = [];
        let secondChanceIndex = 0;
        let secondChanceCorrect = 0;
        let secondChanceStartTime = null;

        // Start Second Chance Mode
        function startSecondChance() {
            if (wrongAnswers.length === 0) {
                alert('No wrong answers to review!');
                return;
            }

            // Initialize second chance mode
            isSecondChanceMode = true;
            secondChanceQuestions = [...wrongAnswers]; // Copy wrong answers
            secondChanceIndex = 0;
            secondChanceCorrect = 0;
            secondChanceStartTime = new Date();

            // Show quiz section and hide results
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('gameStats').style.display = 'flex';

            // Update UI for second chance mode
            updateSecondChanceDisplay();
            displaySecondChanceQuestion();
        }

        // Display current second chance question
        function displaySecondChanceQuestion() {
            if (secondChanceIndex >= secondChanceQuestions.length) {
                finishSecondChance();
                return;
            }

            const questionData = secondChanceQuestions[secondChanceIndex];
            const questionHtml = `
                <div class="question-card ${questionData.difficulty}">
                    <div class="question-header">
                        <div class="question-number">
                            üéØ Second Chance: Question ${secondChanceIndex + 1} of ${secondChanceQuestions.length}
                        </div>
                        <div class="difficulty-badge ${questionData.difficulty}">
                            ${questionData.difficulty.toUpperCase()}
                        </div>
                    </div>
                    
                    <div class="question-text">
                        ${questionData.question}
                    </div>
                    
                    ${questionData.code ? `
                        <div class="code-block">
                            <pre><code class="language-python">${questionData.code}</code></pre>
                        </div>
                    ` : ''}
                    
                    <div class="options-container" id="secondChanceOptions${secondChanceIndex}">
                        ${questionData.options.map((option, index) => `
                            <div class="answer-option ${index === questionData.selectedIndex ? 'was-selected' : ''}" 
                                 onclick="selectSecondChanceAnswer(${index})">
                                <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                                <span class="option-text">${option}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="second-chance-hint">
                        <div class="hint-header">üí° Your previous answer was: <strong>${String.fromCharCode(65 + questionData.selectedIndex)}</strong></div>
                        <div class="hint-text">Think carefully about the correct answer!</div>
                    </div>
                </div>
            `;

            document.getElementById('quizQuestions').innerHTML = questionHtml;
            
            // Highlight code if present
            if (questionData.code && window.Prism) {
                Prism.highlightAll();
            }
        }

        // Handle second chance answer selection
        window.selectSecondChanceAnswer = function(selectedIndex) {
            const questionData = secondChanceQuestions[secondChanceIndex];
            const isCorrect = selectedIndex === questionData.correct;
            
            if (isCorrect) {
                secondChanceCorrect++;
                
                // Award bonus points and power-ups for second chance success
                playerScore += 50; // Bonus points for correction
                powerUps += 1; // Bonus power-up
                
                // Show success animation
                showSecondChanceSuccess();
            } else {
                // Show explanation for still wrong answer
                showSecondChanceExplanation(questionData);
            }

            // Update UI
            const options = document.querySelectorAll(`#secondChanceOptions${secondChanceIndex} .answer-option`);
            const selectedOption = options[selectedIndex];
            const correctOption = options[questionData.correct];

            if (isCorrect) {
                selectedOption.classList.add('correct');
            } else {
                selectedOption.classList.add('incorrect');
                correctOption.classList.add('correct');
            }

            // Disable all options
            options.forEach(option => option.style.pointerEvents = 'none');

            // Move to next question after delay
            setTimeout(() => {
                secondChanceIndex++;
                displaySecondChanceQuestion();
            }, 2000);
        };

        // Show success animation for correct second chance answer
        function showSecondChanceSuccess() {
            // Confetti effect
            if (window.confetti) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57']
                });
            }

            // Success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                font-size: 1.5rem;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            `;
            message.innerHTML = 'üéâ Correct! +50 points & +1 power-up!';
            document.body.appendChild(message);

            setTimeout(() => {
                document.body.removeChild(message);
            }, 1500);
        }

        // Show explanation for still incorrect answer
        function showSecondChanceExplanation(questionData) {
            if (questionData.explanation) {
                const explanation = document.createElement('div');
                explanation.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #fff3cd;
                    border: 2px solid #ffc107;
                    color: #856404;
                    padding: 20px;
                    border-radius: 15px;
                    max-width: 500px;
                    z-index: 1000;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                `;
                explanation.innerHTML = `
                    <h4>üí° Explanation:</h4>
                    <p>${questionData.explanation}</p>
                `;
                document.body.appendChild(explanation);

                setTimeout(() => {
                    document.body.removeChild(explanation);
                }, 3000);
            }
        }

        // Update display for second chance mode
        function updateSecondChanceDisplay() {
            updateGameStats();
            
            // Update progress indicator for second chance
            const progressElement = document.querySelector('.question-number');
            if (progressElement) {
                progressElement.textContent = `üéØ Second Chance: Question ${secondChanceIndex + 1} of ${secondChanceQuestions.length}`;
            }
        }

        // Finish second chance mode
        function finishSecondChance() {
            isSecondChanceMode = false;
            
            const endTime = new Date();
            const totalTime = Math.round((endTime - secondChanceStartTime) / 1000);
            const percentage = Math.round((secondChanceCorrect / secondChanceQuestions.length) * 100);
            
            // Show second chance results
            const resultsHtml = `
                <div class="second-chance-results">
                    <h2>üéØ Second Chance Complete!</h2>
                    <div class="score-display">
                        <div class="score-item">
                            <h3>Questions Corrected</h3>
                            <div style="font-size: 2rem; color: #28a745;">${secondChanceCorrect} / ${secondChanceQuestions.length}</div>
                        </div>
                        <div class="score-item">
                            <h3>Bonus Points Earned</h3>
                            <div style="font-size: 2rem; color: #ffc107;">+${secondChanceCorrect * 50}</div>
                        </div>
                        <div class="score-item">
                            <h3>Power-ups Gained</h3>
                            <div style="font-size: 2rem; color: #6f42c1;">+${secondChanceCorrect}</div>
                        </div>
                    </div>
                    <div class="performance-message">
                        ${percentage >= 80 ? 'üåü Excellent improvement!' : 
                          percentage >= 60 ? 'üëç Good corrections!' : 'üìö Keep practicing these concepts!'}
                    </div>
                    <button class="retry-btn" onclick="restartQuiz()">üîÑ Take Full Quiz Again</button>
                    <button class="retry-btn" onclick="window.location.href='def-advanced.html'">üìö Back to Lessons</button>
                </div>
            `;
            
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('resultsSection').innerHTML = resultsHtml;
            document.getElementById('resultsSection').style.display = 'block';
            
            // Update final score with bonuses
            updateGameStats();
        }

        async function saveQuizResults(results) {
            try {
                console.log('Attempting to save quiz results:', results);
                const docRef = await addDoc(collection(db, 'quizResults'), results);
                console.log('Quiz results saved successfully with ID:', docRef.id);
                
                // Show success notification to user
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #28a745, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-weight: bold;
                `;
                notification.innerHTML = '‚úÖ Results saved to teacher dashboard!';
                document.body.appendChild(notification);
                
                // Check if this is a top score achievement
                checkForLeaderboardAchievement(results.score);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error saving quiz results:', error);
                
                // Show error notification to user
                const errorNotification = document.createElement('div');
                errorNotification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #dc3545, #c82333);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-weight: bold;
                `;
                errorNotification.innerHTML = '‚ùå Error saving results: ' + error.message;
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    if (errorNotification.parentNode) {
                        errorNotification.parentNode.removeChild(errorNotification);
                    }
                }, 5000);
            }
        }

        // Leaderboard Functions
        async function loadLeaderboard() {
            try {
                console.log('Loading leaderboard for period:', currentUserPeriod);
                
                if (!currentUserPeriod) {
                    console.log('No period selected');
                    return;
                }
                
                // Query top 5 players by score for the specific period
                const q = query(
                    collection(db, 'quizResults'),
                    orderBy('score', 'desc'),
                    limit(20) // Get more results to filter by period
                );
                
                const querySnapshot = await getDocs(q);
                const allResults = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Exclude admin from leaderboard
                    if (data.userEmail !== ADMIN_EMAIL) {
                        allResults.push({
                            id: doc.id,
                            userName: data.userName || 'Anonymous Player',
                            userEmail: data.userEmail,
                            period: data.period,
                            score: data.score || 0,
                            level: data.level || 1,
                            streak: data.maxStreak || 0,
                            completedAt: data.completedAt || new Date()
                        });
                    }
                });
                
                // Filter by period and take top 5
                const periodResults = allResults
                    .filter(result => result.period === currentUserPeriod)
                    .slice(0, 5);
                
                displayLeaderboard(periodResults);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                displayLeaderboardError();
            }
        }

        function displayLeaderboard(players) {
            const leaderboardContent = document.getElementById('leaderboardContent');
            
            // Update header to show current period
            const leaderboardTitle = document.querySelector('.leaderboard-title');
            if (leaderboardTitle) {
                leaderboardTitle.innerHTML = `üèÜ Period ${currentUserPeriod} Leaderboard`;
            }
            
            if (players.length === 0) {
                leaderboardContent.innerHTML = `
                    <div class="leaderboard-empty">
                        <div>üèÜ No champions yet in Period ${currentUserPeriod}!</div>
                        <div>Be the first to complete the quiz!</div>
                    </div>
                `;
                return;
            }
            
            const leaderboardHTML = `
                <ul class="leaderboard-list">
                    ${players.map((player, index) => {
                        const rank = index + 1;
                        const crown = rank === 1 ? '<div class="leaderboard-crown">üëë</div>' : '';
                        const avatar = player.userEmail ? 
                            `https://www.gravatar.com/avatar/${btoa(player.userEmail)}?d=identicon&s=45` : 
                            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDUiIGhlaWdodD0iNDUiIHZpZXdCb3g9IjAgMCA0NSA0NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjIuNSIgY3k9IjIyLjUiIHI9IjIyLjUiIGZpbGw9IiM2Njc4ZWEiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGVsbGlwc2UgY3g9IjEyIiBjeT0iOCIgcng9IjUiIHJ5PSI2IiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIuMDEgMTQuNUM2LjE4IDE0LjUgMTUuNDkgMjAgMjAuMDEgMjBIMEMwIDIwIDYuMTggMTQuNSAxMi4wMSAxNC41eiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo=';
                        
                        return `
                            <li class="leaderboard-item">
                                ${crown}
                                <div class="leaderboard-rank">${getRankEmoji(rank)}</div>
                                <img src="${avatar}" alt="${player.userName}" class="leaderboard-avatar" />
                                <div class="leaderboard-info">
                                    <div class="leaderboard-name">${player.userName}</div>
                                    <div class="leaderboard-details">
                                        Level ${player.level} ‚Ä¢ ${player.streak} max streak
                                    </div>
                                </div>
                                <div class="leaderboard-score">
                                    <span class="leaderboard-score-value">${player.score.toLocaleString()}</span>
                                    <span class="leaderboard-score-label">points</span>
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
            
            leaderboardContent.innerHTML = leaderboardHTML;
        }

        function getRankEmoji(rank) {
            switch(rank) {
                case 1: return 'ü•á';
                case 2: return 'ü•à';
                case 3: return 'ü•â';
                default: return `${rank}`;
            }
        }

        function displayLeaderboardError() {
            const leaderboardContent = document.getElementById('leaderboardContent');
            leaderboardContent.innerHTML = `
                <div class="leaderboard-empty">
                    <div>‚ö†Ô∏è Unable to load leaderboard</div>
                    <div>Please check your connection</div>
                </div>
            `;
        }

        // Toggle leaderboard collapse/expand
        function toggleLeaderboard() {
            const wrapper = document.getElementById('leaderboardContentWrapper');
            const button = document.getElementById('leaderboardToggle');
            
            if (wrapper && button) {
                // Toggle wrapper collapse
                wrapper.classList.toggle('collapsed');
                button.classList.toggle('collapsed');
                
                // Save state to localStorage
                const isCollapsed = wrapper.classList.contains('collapsed');
                localStorage.setItem('leaderboardCollapsed', isCollapsed);
                
                // Update button text
                button.textContent = isCollapsed ? '‚ñ∂' : '‚ñº';
            }
        }

        async function refreshLeaderboard() {
            const leaderboardContent = document.getElementById('leaderboardContent');
            leaderboardContent.innerHTML = `
                <div class="leaderboard-loading">
                    <div>üîÑ Refreshing rankings...</div>
                </div>
            `;
            
            // Add a small delay for better UX
            setTimeout(() => {
                loadLeaderboard();
            }, 500);
        }

        async function checkForLeaderboardAchievement(userScore) {
            try {
                // Query current top 5 to see if user's score qualifies
                const q = query(
                    collection(db, 'quizResults'),
                    orderBy('score', 'desc'),
                    limit(5)
                );
                
                const querySnapshot = await getDocs(q);
                const topScores = [];
                
                querySnapshot.forEach((doc) => {
                    topScores.push(doc.data().score || 0);
                });
                
                // Check if user's score makes top 5
                const minTopScore = topScores.length < 5 ? 0 : Math.min(...topScores);
                
                if (userScore > minTopScore || topScores.length < 5) {
                    // User achieved a top 5 score!
                    showLeaderboardAchievement(userScore, topScores);
                }
                
            } catch (error) {
                console.error('Error checking leaderboard achievement:', error);
            }
        }

        function showLeaderboardAchievement(userScore, topScores) {
            const rank = topScores.filter(score => score > userScore).length + 1;
            
            // Create achievement overlay
            const achievementDiv = document.createElement('div');
            achievementDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.5s ease;
            `;
            
            achievementDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #ffd700, #ff6b6b);
                    color: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 500px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    animation: scaleIn 0.5s ease;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 2rem;">LEADERBOARD CHAMPION!</h2>
                    <p style="margin: 0 0 20px 0; font-size: 1.2rem;">
                        You've earned a spot in the Top ${rank}!
                    </p>
                    <p style="margin: 0 0 30px 0; font-size: 1rem; opacity: 0.9;">
                        Score: ${userScore.toLocaleString()} points
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: white;
                        color: #ffd700;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        Awesome! üéâ
                    </button>
                </div>
            `;
            
            document.body.appendChild(achievementDiv);
            
            // Trigger epic confetti
            if (window.confetti) {
                // Multiple bursts for epic celebration
                const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'];
                
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        confetti({
                            particleCount: 150,
                            spread: 120,
                            origin: { y: 0.6 + (i * 0.1) },
                            colors: colors,
                            scalar: 1.2,
                            gravity: 0.8
                        });
                    }, i * 300);
                }
            }
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (achievementDiv.parentNode) {
                    achievementDiv.remove();
                }
            }, 10000);
        }

        // Period selection functions
        function showPeriodSelectionPrompt() {
            const promptDiv = document.createElement('div');
            promptDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            promptDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 400px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    animation: scaleIn 0.3s ease;
                ">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìö</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 1.8rem;">Select Your Class Period</h2>
                    <p style="margin: 0 0 30px 0; font-size: 1rem; opacity: 0.9;">
                        Choose your class period to compete with your classmates.<br>
                        Your selection will be saved for future visits.
                    </p>
                    <select id="periodPromptSelect" style="
                        background: white;
                        color: #2c3e50;
                        border: none;
                        padding: 15px 25px;
                        border-radius: 25px;
                        font-size: 1rem;
                        font-weight: bold;
                        margin-bottom: 20px;
                        width: 200px;
                        outline: none;
                    ">
                        <option value="">Select Period</option>
                        <option value="1">Period 1</option>
                        <option value="3">Period 3</option>
                        <option value="6">Period 6</option>
                    </select><br>
                    <button onclick="confirmPeriodSelection()" style="
                        background: white;
                        color: #667eea;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 1rem;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        Confirm Period
                    </button>
                </div>
            `;
            
            document.body.appendChild(promptDiv);
            
            // Make confirm function globally available
            window.confirmPeriodSelection = function() {
                const selectedPeriod = document.getElementById('periodPromptSelect').value;
                if (selectedPeriod) {
                    currentUserPeriod = selectedPeriod;
                    localStorage.setItem(`userPeriod_${currentUser.uid}`, selectedPeriod);
                    document.getElementById('periodSelect').value = selectedPeriod;
                    loadLeaderboard();
                    document.getElementById('refreshBtn').style.display = 'block';
                    promptDiv.remove();
                } else {
                    alert('Please select a period first!');
                }
            };
        }

        function onPeriodChange() {
            const selectedPeriod = document.getElementById('periodSelect').value;
            if (selectedPeriod) {
                currentUserPeriod = selectedPeriod;
                localStorage.setItem(`userPeriod_${currentUser.uid}`, selectedPeriod);
                loadLeaderboard();
                document.getElementById('refreshBtn').style.display = 'block';
            } else {
                document.getElementById('leaderboardContent').innerHTML = `
                    <div class="leaderboard-empty">
                        <div>üìö Select your period to view rankings</div>
                    </div>
                `;
                document.getElementById('refreshBtn').style.display = 'none';
            }
        }

        // Admin and user management functions
        // Force all users to have a fresh start (Admin only)
        function forceAllUsersFreshStart() {
            if (!isAdmin) {
                alert('Access denied: Admin only function');
                return;
            }
            
            if (confirm('This will clear all saved quiz states and force everyone to start fresh. Continue?')) {
                // Clear localStorage for all quiz-related data
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('quizState_') || key.startsWith('userProgress_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                alert('All saved quiz states cleared. Users will start fresh on next login.');
                
                // Restart current user's quiz
                restartQuiz();
            }
        }

        async function resetAllData() {
            if (!isAdmin) {
                alert('Access denied: Admin only function');
                return;
            }
            
            const confirmReset = confirm(`
‚ö†Ô∏è ADMIN RESET CONFIRMATION ‚ö†Ô∏è

This will permanently delete ALL quiz data including:
- All student scores and progress
- All leaderboard entries
- All saved quiz states

This action CANNOT be undone!

Type "RESET" in the next prompt to confirm.
            `);
            
            if (!confirmReset) return;
            
            const confirmText = prompt('Type "RESET" to confirm deletion of all data:');
            if (confirmText !== 'RESET') {
                alert('Reset cancelled - confirmation text did not match');
                return;
            }
            
            try {
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 30px;
                    border-radius: 10px;
                    z-index: 10000;
                    text-align: center;
                `;
                loadingDiv.innerHTML = 'üóëÔ∏è Resetting all data...<br>Please wait...';
                document.body.appendChild(loadingDiv);
                
                // Query all quiz results
                const q = query(collection(db, 'quizResults'));
                const querySnapshot = await getDocs(q);
                
                // Delete all documents
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                // Clear local storage for all users
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('userPeriod_') || key.includes('quizState_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                loadingDiv.remove();
                
                // Show success message
                alert(`‚úÖ Reset Complete!\n\n${deletePromises.length} records deleted.\nAll leaderboards cleared.\nLocal storage cleaned.`);
                
                // Refresh leaderboard
                refreshLeaderboard();
                
            } catch (error) {
                console.error('Error resetting data:', error);
                alert('‚ùå Error resetting data: ' + error.message);
            }
        }

        function changePeriodForUser() {
            const currentPeriod = localStorage.getItem(`userPeriod_${currentUser.uid}`);
            
            // Create period change modal
            const modalDiv = document.createElement('div');
            modalDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            modalDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 400px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    animation: scaleIn 0.3s ease;
                ">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìö</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 1.8rem;">Change Class Period</h2>
                    <p style="margin: 0 0 20px 0; font-size: 1rem; opacity: 0.9;">
                        Current Period: <strong>${currentPeriod || 'None'}</strong><br>
                        Select your new period:
                    </p>
                    <select id="newPeriodSelect" style="
                        background: white;
                        color: #2c3e50;
                        border: none;
                        padding: 15px 25px;
                        border-radius: 25px;
                        font-size: 1rem;
                        font-weight: bold;
                        margin-bottom: 20px;
                        width: 200px;
                        outline: none;
                    ">
                        <option value="">Select Period</option>
                        <option value="1" ${currentPeriod === '1' ? 'selected' : ''}>Period 1</option>
                        <option value="3" ${currentPeriod === '3' ? 'selected' : ''}>Period 3</option>
                        <option value="6" ${currentPeriod === '6' ? 'selected' : ''}>Period 6</option>
                    </select><br>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="confirmPeriodChange()" style="
                            background: white;
                            color: #667eea;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 25px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">
                            Change Period
                        </button>
                        <button onclick="cancelPeriodChange()" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 2px solid white;
                            padding: 13px 25px;
                            border-radius: 25px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalDiv);
            
            // Make functions globally available
            window.confirmPeriodChange = function() {
                const newPeriod = document.getElementById('newPeriodSelect').value;
                if (newPeriod && newPeriod !== currentPeriod) {
                    localStorage.setItem(`userPeriod_${currentUser.uid}`, newPeriod);
                    currentUserPeriod = newPeriod;
                    document.getElementById('periodSelect').value = newPeriod;
                    loadLeaderboard();
                    document.getElementById('refreshBtn').style.display = 'block';
                    
                    // Update user info display
                    showQuiz();
                    
                    alert(`‚úÖ Period changed to Period ${newPeriod}`);
                } else if (!newPeriod) {
                    alert('Please select a period first!');
                    return;
                } else {
                    alert('You are already in that period!');
                }
                modalDiv.remove();
            };
            
            window.cancelPeriodChange = function() {
                modalDiv.remove();
            };
        }

        // Auto-save progress periodically
        setInterval(async () => {
            if (currentUser && currentQuestionIndex > 0) {
                try {
                    const progress = {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userEmail: currentUser.email,
                        userPhoto: currentUser.photoURL,
                        currentQuestion: currentQuestionIndex,
                        answers: userAnswers,
                        lastUpdated: serverTimestamp()
                    };
                    
                    await setDoc(doc(db, 'quizProgress', currentUser.uid), progress);
                } catch (error) {
                    console.log('Progress save error:', error);
                }
            }
        }, 30000); // Save every 30 seconds

    </script>
</body>
</html>
