<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEF Quiz - Execution Tracing | Code with Morais</title>
    
    <!-- Prism.js for professional Python syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- Confetti.js for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Firebase SDK - Using modular approach -->
    <script src="firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-y: auto; /* Allow vertical scrolling */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Disable right-click context menu */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Quiz lockdown overlay */
        .lockdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 1.5rem;
            text-align: center;
        }

        .lockdown-warning {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            padding: 30px;
            border-radius: 20px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Security notification */
        .security-notice {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: visible; /* Allow content to show */
            margin-top: 50px; /* Account for security notice */
            margin-bottom: 50px; /* Add bottom margin for scrolling */
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .quiz-info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: bold;
        }

        .login-section {
            padding: 40px 30px;
            text-align: center;
        }

        .google-login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .google-login-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }

        .user-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #28a745;
        }

        .quiz-content {
            padding: 30px;
            display: none;
            max-height: none; /* Remove height restrictions */
            overflow: visible; /* Allow content to flow naturally */
        }

        .progress-bar {
            background: #f0f0f0;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 30px;
            height: 20px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 25px;
        }

        .question-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .question-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.3rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .code-block {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007acc;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .code-block::before {
            content: "Python";
            position: absolute;
            top: 8px;
            right: 12px;
            background: #007acc;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .code-block pre {
            margin: 0;
            padding: 0;
            background: transparent !important;
            border: none !important;
            font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
            overflow: visible;
        }

        .code-block code {
            background: transparent !important;
            padding: 0 !important;
            color: inherit !important;
            font-family: inherit !important;
            font-size: inherit !important;
        }

        /* Custom Python syntax highlighting improvements */
        .code-block .token.keyword {
            color: #ff79c6 !important;
            font-weight: bold;
        }

        .code-block .token.function {
            color: #50fa7b !important;
        }

        .code-block .token.string {
            color: #f1fa8c !important;
        }

        .code-block .token.number {
            color: #bd93f9 !important;
        }

        .code-block .token.operator {
            color: #ff79c6 !important;
        }

        .code-block .token.comment {
            color: #6272a4 !important;
            font-style: italic;
        }

        .code-block .token.punctuation {
            color: #f8f8f2 !important;
        }

        .code-block .token.builtin {
            color: #8be9fd !important;
        }

        /* Line numbers styling */
        .code-block .line-numbers {
            position: absolute;
            top: 0;
            left: 0;
            width: 3em;
            letter-spacing: -1px;
            border-right: 1px solid #44475a;
            user-select: none;
            pointer-events: none;
        }

        .code-block .line-numbers-rows {
            position: absolute;
            pointer-events: none;
            top: 0;
            font-size: 100%;
            left: -3.8em;
            width: 3em;
            letter-spacing: -1px;
            border-right: 1px solid #44475a;
            user-select: none;
        }

        .code-block .line-numbers-rows > span {
            display: block;
            counter-increment: linenumber;
        }

        .code-block .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #6272a4;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .next-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: none;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .results-section {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #28a745;
            margin: 20px 0;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .score-item {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .retry-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 10px;
            transition: all 0.3s ease;
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #5a6268;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .quiz-content {
                padding: 20px 15px;
            }
            
            .question-card {
                padding: 20px;
            }
        }

        /* Gamification Styles */
        .game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(145deg, #fff, #f8f9fa);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .streak-indicator {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            animation: pulse 2s infinite;
        }

        .achievement-badge {
            background: linear-gradient(45deg, #48dbfb, #0abde3);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 5px;
            display: inline-block;
            animation: bounce 1s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-30px,0); }
            70% { transform: translate3d(0,-15px,0); }
            90% { transform: translate3d(0,-4px,0); }
        }

        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            font-size: 1.5rem;
            font-weight: bold;
            animation: levelUp 3s ease forwards;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes levelUp {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .points-animation {
            position: absolute;
            top: -20px;
            right: 20px;
            color: #2ecc71;
            font-weight: bold;
            font-size: 1.2rem;
            animation: pointsFloat 2s ease forwards;
            pointer-events: none;
        }

        @keyframes pointsFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        /* Security animation styles */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes securityPulse {
            0%, 100% { background: linear-gradient(45deg, #dc3545, #c82333); }
            50% { background: linear-gradient(45deg, #e74c3c, #dc3545); }
        }

        .security-notice {
            animation: securityPulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Security Notice -->
    <div class="security-notice" id="securityNotice">
        üîí QUIZ MODE ACTIVE - Stay on this page until completion. Leaving will be monitored.
    </div>

    <!-- Lockdown Overlay (hidden by default) -->
    <div class="lockdown-overlay" id="lockdownOverlay" style="display: none;">
        <div class="lockdown-warning">
            <h2>‚ö†Ô∏è Quiz Security Alert</h2>
            <p>You attempted to leave the quiz page.</p>
            <p>Please return to complete your exam.</p>
            <p>This incident has been logged.</p>
            <button onclick="returnToQuiz()" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
            ">Return to Quiz</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üß† DEF Execution Tracing Quiz</h1>
            <p>Test your function execution and conditional logic skills!</p>
        </div>

        <!-- Game Stats Section -->
        <div class="game-stats" id="gameStats" style="display: none;">
            <div class="stat-item">
                <span class="stat-value" id="playerScore">0</span>
                <span class="stat-label">Score</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="currentStreak">0</span>
                <span class="stat-label">Streak</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="playerLevel">1</span>
                <span class="stat-label">Level</span>
            </div>
            <div class="stat-item">
                <div id="achievements"></div>
            </div>
        </div>

        <div class="quiz-info">
            <span class="icon">üéØ</span>
            <strong>20 Questions ‚Ä¢ Progressive Difficulty ‚Ä¢ Execution Tracing</strong><br>
            Questions get progressively harder - no feedback until completion
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">Sign in to start the quiz</h2>
            <p style="margin-bottom: 30px; color: #6c757d;">Your progress and scores will be saved to your account</p>
            <button class="google-login-btn" onclick="window.signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- Quiz Content -->
        <div class="quiz-content" id="quizContent">
            <div class="user-info" id="userInfo"></div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- Emergency Help Button -->
            <div style="text-align: right; margin: 10px 0;">
                <button onclick="showEmergencyHelp()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    cursor: pointer;
                    opacity: 0.7;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                    üÜò Need Help?
                </button>
            </div>
            
            <div id="quizQuestions"></div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h2>üéâ Quiz Complete!</h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="score-breakdown" id="scoreBreakdown"></div>
            <button class="retry-btn" onclick="restartQuiz()" id="retryButton">üîÑ Retake Quiz</button>
            <button class="retry-btn" onclick="window.location.href='def-advanced.html'">üìö Back to Lessons</button>
            <button class="retry-btn" onclick="window.open('quiz-teacher-dashboard.html', '_blank')" style="background: linear-gradient(135deg, #17a2b8, #138496);">üë®‚Äçüè´ Teacher Dashboard</button>
        </div>
    </div>

    <script type="module">
        // Security and Lockdown Functions
        let quizStarted = false;
        let securityViolations = [];
        let isQuizActive = false;
        let tabSwitchCount = 0;
        let rightClickCount = 0;
        let devToolsAttempts = 0;

        // Prevent common exit attempts
        function initSecurityMeasures() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                rightClickCount++;
                logSecurityViolation('Right-click attempt', 'Student attempted to access context menu');
                showSecurityWarning('Right-click is disabled during the quiz');
                return false;
            });

            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+U
            document.addEventListener('keydown', function(e) {
                // F12
                if (e.keyCode === 123) {
                    e.preventDefault();
                    devToolsAttempts++;
                    logSecurityViolation('F12 Developer Tools', 'Student attempted to open developer tools with F12');
                    showSecurityWarning('Developer tools are disabled during the quiz');
                    return false;
                }
                
                // Ctrl+Shift+I (Developer Tools)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    devToolsAttempts++;
                    logSecurityViolation('Ctrl+Shift+I', 'Student attempted to open developer tools');
                    showSecurityWarning('Developer tools are disabled during the quiz');
                    return false;
                }
                
                // Ctrl+Shift+C (Inspect Element)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                    e.preventDefault();
                    devToolsAttempts++;
                    logSecurityViolation('Ctrl+Shift+C', 'Student attempted to inspect element');
                    showSecurityWarning('Inspect element is disabled during the quiz');
                    return false;
                }
                
                // Ctrl+U (View Source)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    logSecurityViolation('Ctrl+U', 'Student attempted to view page source');
                    showSecurityWarning('View source is disabled during the quiz');
                    return false;
                }

                // Ctrl+S (Save Page)
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    logSecurityViolation('Ctrl+S', 'Student attempted to save page');
                    showSecurityWarning('Saving the page is not allowed during the quiz');
                    return false;
                }

                // Alt+Tab (Task switching)
                if (e.altKey && e.keyCode === 9) {
                    e.preventDefault();
                    logSecurityViolation('Alt+Tab', 'Student attempted to switch applications');
                    showSecurityWarning('Switching applications is monitored during the quiz');
                    return false;
                }

                // Ctrl+Tab (Tab switching in browser)
                if (e.ctrlKey && e.keyCode === 9) {
                    e.preventDefault();
                    logSecurityViolation('Ctrl+Tab', 'Student attempted to switch browser tabs');
                    showSecurityWarning('Switching tabs is not allowed during the quiz');
                    return false;
                }
            });

            // Detect tab/window focus changes
            document.addEventListener('visibilitychange', function() {
                if (isQuizActive && document.hidden) {
                    tabSwitchCount++;
                    logSecurityViolation('Tab Switch', 'Student switched away from quiz tab');
                    showLockdownOverlay();
                }
            });

            // Detect window blur (leaving the window)
            window.addEventListener('blur', function() {
                if (isQuizActive) {
                    tabSwitchCount++;
                    logSecurityViolation('Window Blur', 'Student left the quiz window');
                    showLockdownOverlay();
                }
            });

            // Prevent text selection and drag
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });

            // Disable print
            window.addEventListener('beforeprint', function(e) {
                e.preventDefault();
                logSecurityViolation('Print Attempt', 'Student attempted to print the quiz');
                showSecurityWarning('Printing is not allowed during the quiz');
                return false;
            });

            // Monitor for developer tools (basic detection)
            let devtools = {
                open: false,
                orientation: null
            };
            
            const threshold = 160;
            setInterval(function() {
                if (isQuizActive) {
                    if (window.outerHeight - window.innerHeight > threshold || 
                        window.outerWidth - window.innerWidth > threshold) {
                        if (!devtools.open) {
                            devtools.open = true;
                            devToolsAttempts++;
                            logSecurityViolation('Developer Tools Detected', 'Developer tools appear to be open');
                            showSecurityWarning('Please close developer tools to continue the quiz');
                        }
                    } else {
                        devtools.open = false;
                    }
                }
            }, 500);
        }

        // Log security violations
        function logSecurityViolation(type, description) {
            const violation = {
                type: type,
                description: description,
                timestamp: new Date().toISOString(),
                questionNumber: currentQuestionIndex + 1,
                userId: currentUser ? currentUser.uid : 'unknown',
                userAgent: navigator.userAgent
            };
            
            securityViolations.push(violation);
            console.warn('SECURITY VIOLATION:', violation);
            
            // Save to Firebase immediately
            if (currentUser && db) {
                try {
                    addDoc(collection(db, 'securityViolations'), {
                        ...violation,
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userEmail: currentUser.email,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error('Failed to log security violation:', error);
                }
            }
        }

        // Show security warning
        function showSecurityWarning(message) {
            const warning = document.createElement('div');
            warning.style.cssText = `
                position: fixed;
                top: 50px;
                right: 20px;
                background: linear-gradient(45deg, #dc3545, #c82333);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10001;
                font-weight: bold;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            warning.innerHTML = `‚ö†Ô∏è ${message}`;
            document.body.appendChild(warning);
            
            setTimeout(() => {
                if (warning.parentNode) {
                    warning.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (warning.parentNode) {
                            warning.parentNode.removeChild(warning);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Show lockdown overlay
        function showLockdownOverlay() {
            document.getElementById('lockdownOverlay').style.display = 'flex';
        }

        // Return to quiz function
        window.returnToQuiz = function() {
            document.getElementById('lockdownOverlay').style.display = 'none';
            // Log the return
            logSecurityViolation('Returned to Quiz', 'Student returned to quiz after violation');
        };

        // Fullscreen management for Chromebooks
        function enterFullscreen() {
            try {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } catch (error) {
                console.log('Fullscreen not supported or blocked');
            }
        }

        function exitFullscreen() {
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            } catch (error) {
                console.log('Exit fullscreen failed');
            }
        }

        // Monitor fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement && isQuizActive) {
                logSecurityViolation('Fullscreen Exit', 'Student exited fullscreen mode');
                showSecurityWarning('Please stay in fullscreen mode during the quiz');
            }
        });

        // Initialize security when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initSecurityMeasures();
        });

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, onSnapshot, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Initialize Firebase
        let firebaseConfig;
        let app, auth, db, currentUser;

        async function initFirebase() {
            try {
                firebaseConfig = window.firebaseConfig;
                if (!firebaseConfig) {
                    throw new Error('Firebase configuration not found');
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Check for redirect result
                try {
                    const redirectResult = await getRedirectResult(auth);
                    if (redirectResult) {
                        console.log('Redirect auth successful:', redirectResult.user.displayName);
                    }
                } catch (redirectError) {
                    console.warn('Redirect result error:', redirectError);
                }
                
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        // Wait for config to load, then initialize
        window.addEventListener('load', async () => {
            await initFirebase();
        });

        // Make functions globally accessible
        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                
                // Try popup first
                try {
                    await signInWithPopup(auth, provider);
                } catch (popupError) {
                    console.warn('Popup authentication failed, trying redirect:', popupError);
                    
                    // Check if it's a COOP/popup-related error
                    if (popupError.code === 'auth/popup-blocked' || 
                        popupError.code === 'auth/popup-closed-by-user' ||
                        popupError.message.includes('Cross-Origin-Opener-Policy') ||
                        popupError.message.includes('popup')) {
                        
                        // Fallback to redirect
                        await signInWithRedirect(auth, provider);
                        return;
                    } else {
                        // Re-throw non-popup errors
                        throw popupError;
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again or refresh the page.');
            }
        };

        window.signOutUser = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        window.confirmSignOut = function() {
            if (isQuizActive && currentQuestionIndex < questions.length - 1) {
                const confirmed = confirm(
                    'Warning: You are in the middle of taking the quiz. ' +
                    'Signing out will end your session and you may not be able to retake it. ' +
                    'Are you sure you want to sign out?'
                );
                if (confirmed) {
                    logSecurityViolation('Forced Sign Out', 'Student signed out during active quiz');
                    window.signOutUser();
                }
            } else {
                window.signOutUser();
            }
        };

        // Debug function to help troubleshoot clicking issues
        function debugQuizClickState() {
            console.log('=== QUIZ CLICK DEBUG STATE ===');
            console.log('isQuizActive:', isQuizActive);
            console.log('currentQuestionIndex:', currentQuestionIndex);
            console.log('questions.length:', questions.length);
            console.log('userAnswers length:', userAnswers.length);
            console.log('Current question answered:', !!userAnswers[currentQuestionIndex]);
            
            const options = document.querySelectorAll('.option');
            console.log('Available options:', options.length);
            options.forEach((option, index) => {
                console.log(`Option ${index}:`, {
                    element: option,
                    onclick: option.onclick,
                    hasEventListener: option._hasClickListener || false,
                    visible: option.offsetParent !== null,
                    disabled: option.disabled,
                    classList: Array.from(option.classList),
                    pointerEvents: getComputedStyle(option).pointerEvents
                });
            });
            
            const nextBtn = document.querySelector('.next-btn');
            if (nextBtn) {
                console.log('Next button:', {
                    element: nextBtn,
                    display: getComputedStyle(nextBtn).display,
                    visibility: getComputedStyle(nextBtn).visibility
                });
            }
            console.log('===============================');
        }

        // Make debug function globally accessible
        window.debugQuizClickState = debugQuizClickState;

        // Enhanced selectOption function with better validation and error handling
        window.selectOption = function(selectedIndex) {
            console.log(`selectOption called with index: ${selectedIndex}`);
            
            // Validate game state
            if (!isQuizActive) {
                console.warn('Quiz is not active');
                return;
            }
            
            // Validate current question
            if (currentQuestionIndex >= questions.length) {
                console.warn('No more questions available');
                return;
            }
            
            // Validate selected index
            if (selectedIndex < 0 || selectedIndex >= questions[currentQuestionIndex].options.length) {
                console.error('Invalid option index:', selectedIndex);
                return;
            }
            
            // Check if already answered
            if (userAnswers[currentQuestionIndex]) {
                console.warn('Question already answered');
                return;
            }
            
            const question = questions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct;
            
            console.log(`Question ${currentQuestionIndex + 1}: Selected option ${selectedIndex}, Correct: ${isCorrect}`);
            
            // Store answer
            userAnswers[currentQuestionIndex] = {
                questionId: question.id,
                selectedIndex: selectedIndex,
                correct: isCorrect,
                timeSpent: new Date() - startTime,
                timestamp: new Date().toISOString()
            };

            if (isCorrect) {
                score++;
                
                // Gamification for correct answers (silent - no immediate feedback)
                handleCorrectAnswer();
            } else {
                // Reset streak on wrong answer
                currentStreak = 0;
                correctAnswersInRow = 0;
            }

            // Update UI - Mark selected option but don't show correct/incorrect
            const options = document.querySelectorAll(`#options${currentQuestionIndex} .option`);
            
            if (options.length === 0) {
                console.error('No options found for current question');
                return;
            }
            
            if (selectedIndex >= options.length) {
                console.error('Selected index exceeds available options');
                return;
            }
            
            const selectedOption = options[selectedIndex];
            
            if (!selectedOption) {
                console.error('Selected option element not found');
                return;
            }
            
            options.forEach((option, index) => {
                if (!option) return;
                
                option.onclick = null; // Disable further clicks
                option.style.pointerEvents = 'none'; // Extra protection
                
                if (index === selectedIndex) {
                    option.classList.add('selected');
                    console.log(`Option ${index} marked as selected`);
                }
            });

            // Update game stats (silently)
            updateGameStats();

            // Save state after each answer
            saveQuizState();

            // Show next button immediately with multiple fallbacks
            const nextBtnId = `nextBtn${currentQuestionIndex}`;
            let nextBtn = document.getElementById(nextBtnId);
            
            if (nextBtn) {
                nextBtn.style.display = 'inline-block';
                nextBtn.style.visibility = 'visible';
                console.log('Next button shown via ID');
            } else {
                // Fallback 1: try to find button by class and question container
                const questionCard = document.getElementById(`question${currentQuestionIndex}`);
                if (questionCard) {
                    const fallbackBtn = questionCard.querySelector('.next-btn');
                    if (fallbackBtn) {
                        fallbackBtn.style.display = 'inline-block';
                        fallbackBtn.style.visibility = 'visible';
                        console.log('Next button shown via fallback 1');
                    }
                }
                
                // Fallback 2: find any next button in the questions container
                if (!nextBtn) {
                    const questionsContainer = document.getElementById('quizQuestions');
                    if (questionsContainer) {
                        const anyNextBtn = questionsContainer.querySelector('.next-btn');
                        if (anyNextBtn) {
                            anyNextBtn.style.display = 'inline-block';
                            anyNextBtn.style.visibility = 'visible';
                            console.log('Next button shown via fallback 2');
                        }
                    }
                }
            }
            
            console.log(`Answer recorded for question ${currentQuestionIndex + 1}`);
        };

        window.nextQuestion = async function() {
            currentQuestionIndex++;
            
            // Update session progress
            await updateQuizSession({
                currentQuestion: currentQuestionIndex,
                questionsAnswered: userAnswers.length,
                progress: Math.round((currentQuestionIndex / questions.length) * 100)
            });
            
            // Save state after progressing to next question
            saveQuizState();
            
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
            } else {
                displayQuestion();
            }
        };

        window.restartQuiz = function() {
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            startTime = new Date();
            showQuiz();
        };

        // Function to format code with professional Python syntax highlighting
        function formatPythonCode(code) {
            // Create a temporary element to let Prism.js handle the highlighting
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<pre><code class="language-python">${code}</code></pre>`;
            
            // Apply Prism.js highlighting
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(tempDiv);
                return tempDiv.innerHTML;
            } else {
                // Fallback if Prism.js isn't loaded yet
                return `<pre><code class="language-python">${code}</code></pre>`;
            }
        }

        // Quiz Questions Data - 20 Questions arranged from Easy to Hard
        const questions = [
            // EASY LEVEL (Questions 1-5) - Basic function calls and simple conditionals
            {
                id: 1,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def simple_add(x):
    return x + 5

result = simple_add(10)`,
                options: ["10", "15", "5", "20"],
                correct: 1,
                explanation: "simple_add(10) returns 10 + 5 = 15."
            },
            {
                id: 2,
                question: "What is the final value of the variable `output` after the following code block executes?",
                code: `def check_positive(num):
    if num > 0:
        return "positive"
    return "not positive"

output = check_positive(7)`,
                options: ["positive", "not positive", "7", "0"],
                correct: 0,
                explanation: "check_positive(7): Since 7 > 0, return 'positive'."
            },
            {
                id: 3,
                question: "What is the final value of the variable `x` after the following code block executes?",
                code: `x = 8
if x > 5:
    x = x + 2
else:
    x = x - 2`,
                options: ["6", "8", "10", "3"],
                correct: 2,
                explanation: "x = 8, since 8 > 5, execute x = 8 + 2 = 10."
            },
            {
                id: 4,
                question: "What is the final value of the variable `answer` after the following code block executes?",
                code: `def double_value(n):
    return n * 2

answer = double_value(6)`,
                options: ["6", "12", "8", "3"],
                correct: 1,
                explanation: "double_value(6) returns 6 * 2 = 12."
            },
            {
                id: 5,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def max_of_two(a, b):
    if a > b:
        return a
    return b

result = max_of_two(3, 7)`,
                options: ["3", "7", "10", "4"],
                correct: 1,
                explanation: "max_of_two(3, 7): Since 3 is not > 7, return 7."
            },

            // MEDIUM LEVEL (Questions 6-12) - Multiple conditionals, variable modifications
            {
                id: 6,
                question: "What is the final value of the variable `val` after the following code block executes?",
                code: `def process_number(num):
    if num % 2 == 0:
        return num / 2
    return num * 3

val = process_number(8)`,
                options: ["4", "24", "8", "16"],
                correct: 0,
                explanation: "process_number(8): Since 8 % 2 == 0 (8 is even), return 8 / 2 = 4."
            },
            {
                id: 7,
                question: "What is the final value of the variable `score` after the following code block executes?",
                code: `def calculate_grade(points):
    if points >= 90:
        return "A"
    elif points >= 80:
        return "B"
    elif points >= 70:
        return "C"
    return "F"

grade = calculate_grade(85)
score = len(grade)`,
                options: ["1", "85", "80", "2"],
                correct: 0,
                explanation: "calculate_grade(85): 85 >= 80, so return 'B'. score = len('B') = 1."
            },
            {
                id: 8,
                question: "What is the final value of the variable `total` after the following code block executes?",
                code: `def chain_operations(x):
    x = x + 3
    if x > 10:
        x = x - 2
    return x

total = chain_operations(9)`,
                options: ["10", "12", "9", "14"],
                correct: 0,
                explanation: "chain_operations(9): x = 9 + 3 = 12. Since 12 > 10, x = 12 - 2 = 10. Return 10."
            },
            {
                id: 9,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def transform_value(n):
    if n < 0:
        return abs(n)
    elif n == 0:
        return 1
    return n * n

result = transform_value(-3)`,
                options: ["3", "9", "-3", "1"],
                correct: 0,
                explanation: "transform_value(-3): Since -3 < 0, return abs(-3) = 3."
            },
            {
                id: 10,
                question: "What is the final value of the variable `output` after the following code block executes?",
                code: `def nested_check(a, b):
    if a > b:
        if a > 15:
            return a + b
        return a - b
    return b - a

output = nested_check(12, 8)`,
                options: ["4", "20", "-4", "12"],
                correct: 0,
                explanation: "nested_check(12, 8): 12 > 8 (true), but 12 is not > 15, so return 12 - 8 = 4."
            },
            {
                id: 11,
                question: "What is the final value of the variable `count` after the following code block executes?",
                code: `count = 0
numbers = [2, 5, 8, 3, 9]
for num in numbers:
    if num > 5:
        count += 1`,
                options: ["2", "3", "1", "5"],
                correct: 0,
                explanation: "Loop through [2, 5, 8, 3, 9]: 8 > 5 (count=1), 9 > 5 (count=2). Final count = 2."
            },
            {
                id: 12,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def logic_test(x, y, z):
    if x and y:
        return z
    elif x or y:
        return not z
    return x

result = logic_test(True, False, True)`,
                options: ["False", "True", "None", "1"],
                correct: 0,
                explanation: "logic_test(True, False, True): True and False = False, but True or False = True, so return not True = False."
            },

            // HARD LEVEL (Questions 13-20) - Complex nested functions, global variables, advanced logic
            {
                id: 13,
                question: "What is the final value of the variable `final_result` after the following code block executes?",
                code: `def complex_calc(a, b, c):
    if a > b and b > c:
        return a + b + c
    elif a > c:
        return a * b
    return c - a + b

final_result = complex_calc(10, 5, 3)`,
                options: ["18", "50", "7", "-2"],
                correct: 0,
                explanation: "complex_calc(10, 5, 3): 10 > 5 and 5 > 3 (both true), so return 10 + 5 + 3 = 18."
            },
            {
                id: 14,
                question: "What is the final value of the variable `data` after the following code block executes?",
                code: `data = 5
def process(d):
    global data
    d = d * 2
    data = d + 1
    return d - 1

result = process(data)
data = result - 1`,
                options: ["9", "10", "8", "11"],
                correct: 2,
                explanation: "process(5): d=10, global data=11, return 9. Then data = 9 - 1 = 8."
            },
            {
                id: 15,
                question: "What is the final value of the variable `answer` after the following code block executes?",
                code: `def recursive_sum(n):
    if n <= 1:
        return 1
    return n + recursive_sum(n - 1)

answer = recursive_sum(4)`,
                options: ["10", "4", "1", "24"],
                correct: 0,
                explanation: "recursive_sum(4): 4 + recursive_sum(3) = 4 + (3 + 2 + 1) = 10."
            },
            {
                id: 16,
                question: "What value is stored at index 1 in the list `arr` after the following code executes?",
                code: `arr = [10, 20, 30, 40]
def modify_array(lst):
    lst[0] = lst[0] + lst[1]
    lst.pop()
    return lst[0]

val = modify_array(arr)
arr.insert(1, val)`,
                options: ["20", "30", "40", "10"],
                correct: 1,
                explanation: "modify_array changes arr[0] to 30, removes 40, returns 30. arr.insert(1, 30) puts 30 at index 1."
            },
            {
                id: 17,
                question: "What is the final value of the variable `counter` after the following code block executes?",
                code: `counter = 1
while counter < 16:
    if counter == 8:
        break
    counter *= 2

counter += 3`,
                options: ["11", "8", "19", "16"],
                correct: 0,
                explanation: "counter: 1‚Üí2‚Üí4‚Üí8. At 8, break occurs. Then counter = 8 + 3 = 11."
            },
            {
                id: 18,
                question: "What is the final value of the variable `result` after the following code block executes?",
                code: `def multi_condition(a, b, c):
    if a > b and a > c:
        if b > c:
            return a + b - c
        return a - b + c
    elif b > c:
        return b * c
    return a + b + c

result = multi_condition(8, 6, 4)`,
                options: ["10", "24", "18", "12"],
                correct: 0,
                explanation: "multi_condition(8, 6, 4): 8 > 6 and 8 > 4 (true), 6 > 4 (true), so return 8 + 6 - 4 = 10."
            },
            {
                id: 19,
                question: "What is the final value of the variable `total` after the following code block executes?",
                code: `total = 0
def nested_loops():
    result = 0
    for i in range(1, 4):
        for j in range(2):
            result += i * (j + 1)
    return result

total = nested_loops()`,
                options: ["18", "12", "9", "6"],
                correct: 0,
                explanation: "i=1: j=0‚Üí1*1=1, j=1‚Üí1*2=2. i=2: j=0‚Üí2*1=2, j=1‚Üí2*2=4. i=3: j=0‚Üí3*1=3, j=1‚Üí3*2=6. Total = 1+2+2+4+3+6 = 18."
            },
            {
                id: 20,
                question: "What is the final value of the variable `final_value` after the following code block executes?",
                code: `def complex_function(x, y):
    def inner_calc(a):
        return a * 2 + 1
    
    if x > y:
        return inner_calc(x) + inner_calc(y)
    else:
        return inner_calc(x) * inner_calc(y)

final_value = complex_function(3, 5)`,
                options: ["77", "15", "35", "21"],
                correct: 0,
                explanation: "complex_function(3, 5): 3 not > 5, so return inner_calc(3) * inner_calc(5). inner_calc(3) = 7, inner_calc(5) = 11. Return 7 * 11 = 77."
            }
        ];

        // Quiz state variables
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let startTime = null;
        let quizSessionId = null;
        let hasCompletedQuiz = false;

        // Gamification variables
        let playerScore = 0;
        let currentStreak = 0;
        let maxStreak = 0;
        let playerLevel = 1;
        let achievements = [];
        let correctAnswersInRow = 0;

        // Session management functions
        function generateSessionId() {
            return 'quiz_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function checkQuizEligibility() {
            if (!currentUser || !db) return false;
            
            try {
                // Check if user has already completed this quiz
                const userQuizQuery = query(
                    collection(db, 'quizResults'),
                    orderBy('completedAt', 'desc')
                );
                
                return new Promise((resolve) => {
                    const unsubscribe = onSnapshot(userQuizQuery, (snapshot) => {
                        let hasCompleted = false;
                        const today = new Date().toDateString();
                        
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.userId === currentUser.uid) {
                                const completedDate = data.completedAt?.toDate();
                                if (completedDate && completedDate.toDateString() === today) {
                                    hasCompleted = true;
                                }
                            }
                        });
                        
                        hasCompletedQuiz = hasCompleted;
                        unsubscribe();
                        resolve(!hasCompleted);
                    });
                });
            } catch (error) {
                console.error('Error checking quiz eligibility:', error);
                return true; // Allow quiz if check fails
            }
        }

        async function createQuizSession() {
            if (!currentUser || !db) return;
            
            quizSessionId = generateSessionId();
            
            try {
                await setDoc(doc(db, 'quizSessions', quizSessionId), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    userPhoto: currentUser.photoURL,
                    sessionId: quizSessionId,
                    startTime: serverTimestamp(),
                    status: 'active',
                    questionsTotal: questions.length,
                    currentQuestion: 0,
                    securityViolations: [],
                    browserInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        screenResolution: `${screen.width}x${screen.height}`,
                        windowSize: `${window.innerWidth}x${window.innerHeight}`
                    }
                });
                
                console.log('Quiz session created:', quizSessionId);
            } catch (error) {
                console.error('Error creating quiz session:', error);
            }
        }

        async function updateQuizSession(data) {
            if (!quizSessionId || !db) return;
            
            try {
                await setDoc(doc(db, 'quizSessions', quizSessionId), {
                    ...data,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error updating quiz session:', error);
            }
        }

        // State persistence functions
        function saveQuizState() {
            if (!currentUser) return;
            
            const quizState = {
                currentQuestionIndex,
                userAnswers,
                score,
                startTime: startTime ? startTime.getTime() : null,
                playerScore,
                currentStreak,
                maxStreak,
                playerLevel,
                achievements,
                correctAnswersInRow,
                lastSaved: new Date().getTime()
            };
            
            localStorage.setItem(`quizState_${currentUser.uid}`, JSON.stringify(quizState));
        }

        function loadQuizState() {
            if (!currentUser) return false;
            
            const savedState = localStorage.getItem(`quizState_${currentUser.uid}`);
            if (!savedState) return false;
            
            try {
                const state = JSON.parse(savedState);
                
                // Check if state is recent (within 24 hours)
                const now = new Date().getTime();
                if (now - state.lastSaved > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(`quizState_${currentUser.uid}`);
                    return false;
                }
                
                // Restore state
                currentQuestionIndex = state.currentQuestionIndex || 0;
                userAnswers = state.userAnswers || [];
                score = state.score || 0;
                startTime = state.startTime ? new Date(state.startTime) : new Date();
                playerScore = state.playerScore || 0;
                currentStreak = state.currentStreak || 0;
                maxStreak = state.maxStreak || 0;
                playerLevel = state.playerLevel || 1;
                achievements = state.achievements || [];
                correctAnswersInRow = state.correctAnswersInRow || 0;
                
                return true;
            } catch (error) {
                console.error('Error loading quiz state:', error);
                localStorage.removeItem(`quizState_${currentUser.uid}`);
                return false;
            }
        }

        function clearQuizState() {
            if (!currentUser) return;
            localStorage.removeItem(`quizState_${currentUser.uid}`);
        }

        async function restartQuiz() {
            // Check if user is allowed to restart
            if (hasCompletedQuiz) {
                alert('You have already completed this quiz today. Multiple attempts are not allowed.');
                return;
            }
            
            // Clear saved state
            clearQuizState();
            
            // Reset all variables
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            playerScore = 0;
            currentStreak = 0;
            maxStreak = 0;
            playerLevel = 1;
            achievements = [];
            correctAnswersInRow = 0;
            startTime = new Date();
            securityViolations = [];
            tabSwitchCount = 0;
            rightClickCount = 0;
            devToolsAttempts = 0;
            
            // Create new session
            await createQuizSession();
            
            // Activate security
            isQuizActive = true;
            
            // Show quiz section
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('gameStats').style.display = 'flex';
            
            // Update game stats and display first question
            updateGameStats();
            displayQuestion();
            
            // Save initial state
            saveQuizState();
        }

        // Make restartQuiz globally available
        window.restartQuiz = restartQuiz;

        // Emergency recovery functions for stuck students
        function checkForStuckStudents() {
            // Check if student has answered current question but button is missing
            const currentQuestionCard = document.querySelector('.question-card');
            if (!currentQuestionCard) return;

            const hasAnswered = currentQuestionCard.querySelector('.option.selected');
            const nextButton = currentQuestionCard.querySelector('.next-btn[style*="inline-block"], .next-btn:not([style*="none"])');
            
            console.log('Emergency check - Has answered:', !!hasAnswered, 'Next button visible:', !!nextButton);

            if (hasAnswered && !nextButton) {
                console.log('STUCK STUDENT DETECTED! Initiating emergency recovery...');
                showEmergencyHelp();
            }
        }

        function showEmergencyHelp() {
            // Create emergency help overlay
            const emergencyOverlay = document.createElement('div');
            emergencyOverlay.id = 'emergencyHelp';
            emergencyOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: Arial, sans-serif;
            `;
            
            emergencyOverlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 500px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <h2 style="color: #e74c3c; margin-bottom: 20px;">üö® We're Here to Help!</h2>
                    <p style="font-size: 16px; margin-bottom: 30px; color: #333;">
                        It looks like you answered a question but the Next button didn't appear. 
                        Don't worry - we can fix this right away!
                    </p>
                    <button onclick="emergencyRecovery()" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        margin-right: 15px;
                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                    ">
                        üîß Fix & Continue Quiz
                    </button>
                    <button onclick="closeEmergencyHelp()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 16px;
                        cursor: pointer;
                    ">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(emergencyOverlay);
        }

        function emergencyRecovery() {
            console.log('Executing emergency recovery...');
            
            // Force show next button using multiple methods
            const currentQuestionCard = document.querySelector('.question-card');
            if (currentQuestionCard) {
                // Method 1: Find any hidden next button and show it
                const hiddenButtons = currentQuestionCard.querySelectorAll('.next-btn');
                hiddenButtons.forEach(btn => {
                    btn.style.display = 'inline-block';
                    btn.style.visibility = 'visible';
                });

                // Method 2: Create new next button if none exists
                if (hiddenButtons.length === 0) {
                    const newButton = document.createElement('button');
                    newButton.className = 'next-btn';
                    newButton.style.cssText = `
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        margin-top: 20px;
                        display: inline-block;
                    `;
                    newButton.innerHTML = currentQuestionIndex === questions.length - 1 ? 'Finish Quiz ‚Üí' : 'Next Question ‚Üí';
                    newButton.onclick = () => window.nextQuestion();
                    currentQuestionCard.appendChild(newButton);
                }
            }

            // Close emergency help
            closeEmergencyHelp();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 1000;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            `;
            successMsg.textContent = '‚úÖ Fixed! You can now continue the quiz.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 4000);
        }

        function closeEmergencyHelp() {
            const overlay = document.getElementById('emergencyHelp');
            if (overlay) {
                overlay.parentNode.removeChild(overlay);
            }
        }

        // Make emergency functions globally available
        window.showEmergencyHelp = showEmergencyHelp;
        window.emergencyRecovery = emergencyRecovery;
        window.closeEmergencyHelp = closeEmergencyHelp;

        // Initialize Firebase Auth after Firebase is loaded
        window.addEventListener('load', async () => {
            await initFirebase();
            
            // Set up authentication listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showQuiz();
                } else {
                    showLogin();
                }
            });
        });

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
        }

        async function showQuiz() {
            // Check if user is eligible to take the quiz
            const isEligible = await checkQuizEligibility();
            
            if (!isEligible) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('quizContent').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                
                document.getElementById('resultsSection').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #dc3545;">‚ö†Ô∏è Quiz Already Completed</h2>
                        <p style="font-size: 1.2rem; margin: 20px 0;">You have already completed this quiz today.</p>
                        <p style="color: #6c757d;">Each student can only take the quiz once per day.</p>
                        <button onclick="window.location.href='def-advanced.html'" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 18px;
                            font-weight: bold;
                            margin-top: 20px;
                        ">üìö Back to Lessons</button>
                    </div>
                `;
                return;
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('gameStats').style.display = 'flex';
            
            // Create quiz session
            await createQuizSession();
            
            // Activate quiz security measures
            isQuizActive = true;
            quizStarted = true;
            
            // Try to enter fullscreen for better quiz experience
            setTimeout(() => {
                enterFullscreen();
            }, 1000);
            
            // Log quiz start
            logSecurityViolation('Quiz Started', 'Student began the quiz session');
            
            // Display user info
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <img src="${currentUser.photoURL}" alt="Profile" class="user-avatar">
                <div>
                    <strong>${currentUser.displayName}</strong><br>
                    <span style="color: #6c757d;">${currentUser.email}</span>
                    <span style="color: #28a745; font-size: 0.8rem; display: block;">
                        Session: ${quizSessionId ? quizSessionId.substr(-8) : 'N/A'}
                    </span>
                </div>
                <div style="margin-left: auto;">
                    <button class="logout-btn" onclick="confirmSignOut()">Sign Out</button>
                </div>
            `;

            // Try to restore saved state
            const stateRestored = loadQuizState();
            
            if (!stateRestored) {
                // Initialize new quiz
                currentQuestionIndex = 0;
                userAnswers = [];
                score = 0;
                playerScore = 0;
                currentStreak = 0;
                maxStreak = 0;
                playerLevel = 1;
                achievements = [];
                correctAnswersInRow = 0;
                startTime = new Date();
            } else {
                // Show continuation message
                if (currentQuestionIndex > 0) {
                    const continueMessage = document.createElement('div');
                    continueMessage.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(45deg, #4CAF50, #45a049);
                        color: white;
                        padding: 15px 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        z-index: 1000;
                        font-weight: bold;
                    `;
                    continueMessage.innerHTML = `üîÑ Continuing from Question ${currentQuestionIndex + 1}`;
                    document.body.appendChild(continueMessage);
                    
                    setTimeout(() => {
                        if (continueMessage.parentNode) {
                            continueMessage.parentNode.removeChild(continueMessage);
                        }
                    }, 3000);
                }
            }

            // Update session with initial data
            await updateQuizSession({
                currentQuestion: currentQuestionIndex,
                questionsAnswered: userAnswers.length,
                status: 'in-progress'
            });

            // Update game stats
            updateGameStats();

            // Display current question
            displayQuestion();
            
            // Save state after showing quiz
            saveQuizState();
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            const questionsContainer = document.getElementById('quizQuestions');
            
            // Update progress
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            questionsContainer.innerHTML = `
                <div class="question-card" id="question${currentQuestionIndex}">
                    <div class="question-header">
                        <div class="question-number">${currentQuestionIndex + 1}</div>
                        <div class="question-text">${question.question}</div>
                    </div>
                    <div class="code-block">
                        <pre><code class="language-python">${question.code}</code></pre>
                    </div>
                    <div class="options-container" id="options${currentQuestionIndex}">
                        ${question.options.map((option, index) => `
                            <div class="option" onclick="selectOption(${index})" id="option${currentQuestionIndex}_${index}">
                                <strong>${String.fromCharCode(65 + index)}.</strong> ${option}
                            </div>
                        `).join('')}
                    </div>
                    <button class="next-btn" id="nextBtn${currentQuestionIndex}" onclick="nextQuestion()">
                        ${currentQuestionIndex === questions.length - 1 ? 'Finish Quiz' : 'Next Question'} ‚Üí
                    </button>
                </div>
            `;

            // Apply Prism.js highlighting after DOM insertion
            setTimeout(() => {
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
                
                // Add robust event listeners to all options for extra reliability
                const options = document.querySelectorAll('.option');
                options.forEach((option, index) => {
                    // Add click event listener as backup to onclick
                    option.addEventListener('click', function(e) {
                        console.log(`Backup event listener triggered for option ${index}`);
                        if (isQuizActive && !userAnswers[currentQuestionIndex]) {
                            selectOption(index);
                        }
                    });
                    
                    // Add keyboard support for accessibility
                    option.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            if (isQuizActive && !userAnswers[currentQuestionIndex]) {
                                selectOption(index);
                            }
                        }
                    });
                    
                    // Make options focusable for keyboard navigation
                    option.setAttribute('tabindex', '0');
                    
                    // Mark that this option has event listeners
                    option._hasClickListener = true;
                });
                
                console.log(`Added event listeners to ${options.length} options for question ${currentQuestionIndex + 1}`);
            }, 10);

            // Emergency recovery for stuck students
            setTimeout(() => {
                checkForStuckStudents();
            }, 500);
        }

        async function finishQuiz() {
            const endTime = new Date();
            const totalTime = Math.round((endTime - startTime) / 1000); // seconds
            
            // Deactivate quiz security measures
            isQuizActive = false;
            
            // Exit fullscreen
            exitFullscreen();
            
            // Calculate detailed stats
            const correctAnswers = userAnswers.filter(answer => answer.correct).length;
            const percentage = Math.round((correctAnswers / questions.length) * 100);
            
            // Close quiz session
            await updateQuizSession({
                status: 'completed',
                endTime: serverTimestamp(),
                finalScore: correctAnswers,
                totalQuestions: questions.length,
                percentage: percentage,
                securityViolations: securityViolations,
                completedAt: serverTimestamp()
            });
            
            // Save to Firebase with detailed user data and gamification stats
            saveQuizResults({
                sessionId: quizSessionId,
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userEmail: currentUser.email,
                userPhoto: currentUser.photoURL,
                score: correctAnswers,
                totalQuestions: questions.length,
                percentage: percentage,
                timeSpent: totalTime,
                answers: userAnswers,
                completedAt: serverTimestamp(),
                // Gamification data
                finalScore: playerScore,
                maxStreak: Math.max(maxStreak, currentStreak),
                achievements: achievements,
                level: playerLevel,
                totalCorrectAnswers: correctAnswers,
                // Security data for teacher review
                securityViolations: securityViolations,
                tabSwitchCount: tabSwitchCount,
                rightClickCount: rightClickCount,
                devToolsAttempts: devToolsAttempts,
                // Detailed answer breakdown for teacher analysis
                answerDetails: userAnswers.map((answer, index) => ({
                    questionNumber: index + 1,
                    questionId: answer.questionId,
                    questionText: questions[index].question,
                    questionCode: questions[index].code,
                    userAnswer: questions[index].options[answer.selectedIndex],
                    correctAnswer: questions[index].options[questions[index].correct],
                    isCorrect: answer.correct,
                    timeSpent: answer.timeSpent,
                    explanation: questions[index].explanation,
                    allOptions: questions[index].options
                })),
                // Quiz session metadata
                quizStartTime: startTime,
                quizEndTime: endTime,
                browserInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`
                }
            });

            // Show results
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            document.getElementById('scoreDisplay').innerHTML = `${correctAnswers}/${questions.length}`;
            
            // Performance message
            let performanceMsg = '';
            let performanceColor = '';
            
            if (percentage >= 90) {
                performanceMsg = 'üèÜ Outstanding! Excellent mastery of execution tracing!';
                performanceColor = '#28a745';
            } else if (percentage >= 80) {
                performanceMsg = 'üåü Great job! Very good understanding!';
                performanceColor = '#17a2b8';
            } else if (percentage >= 70) {
                performanceMsg = 'üëç Good work! Keep practicing!';
                performanceColor = '#ffc107';
            } else {
                performanceMsg = 'üìö Keep studying! Review the concepts and try again!';
                performanceColor = '#dc3545';
            }

            // Security summary for display
            let securitySummary = '';
            if (securityViolations.length > 0) {
                securitySummary = `<div class="score-item">
                    <h3 style="color: #dc3545;">Security Incidents</h3>
                    <div style="font-size: 1.5rem; color: #dc3545;">${securityViolations.length}</div>
                    <small>Reported to instructor</small>
                </div>`;
            }

            document.getElementById('scoreBreakdown').innerHTML = `
                <div class="score-item">
                    <h3>Score</h3>
                    <div style="font-size: 2rem; color: ${performanceColor};">${percentage}%</div>
                </div>
                <div class="score-item">
                    <h3>Correct Answers</h3>
                    <div style="font-size: 2rem; color: #28a745;">${correctAnswers}</div>
                </div>
                <div class="score-item">
                    <h3>Time Spent</h3>
                    <div style="font-size: 2rem; color: #6c757d;">${Math.floor(totalTime / 60)}:${(totalTime % 60).toString().padStart(2, '0')}</div>
                </div>
                ${securitySummary}
                <div class="score-item" style="grid-column: 1/-1;">
                    <h3 style="color: ${performanceColor};">${performanceMsg}</h3>
                    <p style="margin-top: 10px; color: #6c757d;">
                        Session ID: ${quizSessionId ? quizSessionId.substr(-8) : 'N/A'} | 
                        Your results have been saved for instructor review.
                    </p>
                </div>
            `;
            
            // Clear saved state since quiz is completed
            clearQuizState();
            
            // Log quiz completion
            logSecurityViolation('Quiz Completed', `Student completed quiz with ${correctAnswers}/${questions.length} correct answers`);
        }

        async function saveQuizResults(results) {
            try {
                console.log('Attempting to save quiz results:', results);
                const docRef = await addDoc(collection(db, 'quizResults'), results);
                console.log('Quiz results saved successfully with ID:', docRef.id);
                
                // Show success notification to user
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #28a745, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-weight: bold;
                `;
                notification.innerHTML = '‚úÖ Results saved to teacher dashboard!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error saving quiz results:', error);
                
                // Show error notification to user
                const errorNotification = document.createElement('div');
                errorNotification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #dc3545, #c82333);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    z-index: 1000;
                    font-weight: bold;
                `;
                errorNotification.innerHTML = '‚ùå Error saving results: ' + error.message;
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    if (errorNotification.parentNode) {
                        errorNotification.parentNode.removeChild(errorNotification);
                    }
                }, 5000);
            }
        }

        // Auto-save progress periodically
        setInterval(async () => {
            if (currentUser && currentQuestionIndex > 0) {
                try {
                    const progress = {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userEmail: currentUser.email,
                        userPhoto: currentUser.photoURL,
                        currentQuestion: currentQuestionIndex,
                        answers: userAnswers,
                        lastUpdated: serverTimestamp()
                    };
                    
                    await setDoc(doc(db, 'quizProgress', currentUser.uid), progress);
                } catch (error) {
                    console.log('Progress save error:', error);
                }
            }
        }, 30000); // Save every 30 seconds

        // Gamification Functions
        function handleCorrectAnswer() {
            // Update streaks and scoring
            currentStreak++;
            correctAnswersInRow++;
            
            // Calculate points based on streak
            let pointsEarned = 100;
            if (currentStreak >= 3) pointsEarned += 50; // Streak bonus
            if (currentStreak >= 5) pointsEarned += 100; // Super streak bonus
            if (currentStreak >= 10) pointsEarned += 200; // Mega streak bonus
            
            playerScore += pointsEarned;
            
            // Update max streak
            if (currentStreak > maxStreak) {
                maxStreak = currentStreak;
            }
            
            // Show points animation
            showPointsAnimation(pointsEarned);
            
            // Trigger confetti
            triggerConfetti();
            
            // Check for achievements
            checkAchievements();
            
            // Check for level up
            checkLevelUp();
        }

        function triggerConfetti() {
            // Different confetti patterns based on streak
            if (currentStreak >= 10) {
                // Mega streak - rainbow explosion
                confetti({
                    particleCount: 150,
                    spread: 180,
                    origin: { y: 0.6 },
                    colors: ['#ff0000', '#ff8000', '#ffff00', '#80ff00', '#00ff00', '#00ff80', '#00ffff', '#0080ff', '#0000ff', '#8000ff', '#ff00ff', '#ff0080']
                });
            } else if (currentStreak >= 5) {
                // Super streak - golden shower
                confetti({
                    particleCount: 100,
                    spread: 120,
                    origin: { y: 0.6 },
                    colors: ['#ffd700', '#ffed4e', '#ffb347', '#ffa500']
                });
            } else if (currentStreak >= 3) {
                // Good streak - celebratory burst
                confetti({
                    particleCount: 75,
                    spread: 90,
                    origin: { y: 0.6 },
                    colors: ['#00ff00', '#32cd32', '#7fff00', '#adff2f']
                });
            } else {
                // Regular correct answer
                confetti({
                    particleCount: 50,
                    spread: 60,
                    origin: { y: 0.6 },
                    colors: ['#007bff', '#28a745', '#17a2b8']
                });
            }
        }

        function showPointsAnimation(points) {
            const questionsContainer = document.getElementById('quizQuestions');
            const pointsElement = document.createElement('div');
            pointsElement.className = 'points-animation';
            pointsElement.textContent = '+' + points;
            questionsContainer.style.position = 'relative';
            questionsContainer.appendChild(pointsElement);
            
            setTimeout(() => {
                if (pointsElement.parentNode) {
                    pointsElement.parentNode.removeChild(pointsElement);
                }
            }, 2000);
        }

        function checkAchievements() {
            const newAchievements = [];
            
            // First correct answer
            if (score === 1 && !achievements.includes('first-correct')) {
                newAchievements.push({id: 'first-correct', name: 'üéØ First Hit', description: 'Got your first answer correct!'});
            }
            
            // Streak achievements
            if (currentStreak === 3 && !achievements.includes('streak-3')) {
                newAchievements.push({id: 'streak-3', name: 'üî• On Fire', description: '3 correct answers in a row!'});
            }
            
            if (currentStreak === 5 && !achievements.includes('streak-5')) {
                newAchievements.push({id: 'streak-5', name: '‚ö° Lightning Round', description: '5 correct answers in a row!'});
            }
            
            if (currentStreak === 10 && !achievements.includes('streak-10')) {
                newAchievements.push({id: 'streak-10', name: 'üöÄ Unstoppable', description: '10 correct answers in a row!'});
            }
            
            // Score achievements
            if (playerScore >= 1000 && !achievements.includes('score-1000')) {
                newAchievements.push({id: 'score-1000', name: 'üí∞ Point Collector', description: 'Earned 1000 points!'});
            }
            
            if (playerScore >= 2500 && !achievements.includes('score-2500')) {
                newAchievements.push({id: 'score-2500', name: 'üëë High Scorer', description: 'Earned 2500 points!'});
            }
            
            // Add new achievements
            newAchievements.forEach(achievement => {
                achievements.push(achievement.id);
                showAchievement(achievement);
            });
        }

        function showAchievement(achievement) {
            const achievementElement = document.createElement('div');
            achievementElement.className = 'achievement-badge';
            achievementElement.textContent = achievement.name;
            achievementElement.title = achievement.description;
            
            const achievementsContainer = document.getElementById('achievements');
            achievementsContainer.appendChild(achievementElement);
            
            // Trigger extra confetti for achievements
            setTimeout(() => {
                confetti({
                    particleCount: 100,
                    spread: 160,
                    origin: { y: 0.3 },
                    colors: ['#48dbfb', '#0abde3', '#006ba6']
                });
            }, 500);
        }

        function checkLevelUp() {
            const newLevel = Math.floor(playerScore / 1000) + 1;
            if (newLevel > playerLevel) {
                playerLevel = newLevel;
                showLevelUpNotification(newLevel);
            }
        }

        function showLevelUpNotification(level) {
            const notification = document.createElement('div');
            notification.className = 'level-up-notification';
            notification.innerHTML = `
                <div>üéâ LEVEL UP! üéâ</div>
                <div style="font-size: 2rem; margin: 10px 0;">Level ${level}</div>
                <div style="font-size: 1rem;">Keep up the great work!</div>
            `;
            
            document.body.appendChild(notification);
            
            // Massive confetti celebration
            setTimeout(() => {
                confetti({
                    particleCount: 200,
                    spread: 200,
                    origin: { y: 0.4 },
                    colors: ['#f093fb', '#f5576c', '#4facfe', '#00f2fe']
                });
            }, 500);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function updateGameStats() {
            document.getElementById('playerScore').textContent = playerScore.toLocaleString();
            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('playerLevel').textContent = playerLevel;
            
            // Add streak indicator if streak >= 3
            const streakElement = document.getElementById('currentStreak');
            if (currentStreak >= 3) {
                streakElement.parentElement.innerHTML = `
                    <span class="stat-value streak-indicator">${currentStreak} üî•</span>
                    <span class="stat-label">Streak</span>
                `;
            } else {
                streakElement.parentElement.innerHTML = `
                    <span class="stat-value" id="currentStreak">${currentStreak}</span>
                    <span class="stat-label">Streak</span>
                `;
            }
        }
    </script>
</body>
</html>