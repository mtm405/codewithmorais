<!-- templates/partials/code_editor.html -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/code_editor.css') }}">
<div class="code-editor-block">
  {% set editor_id = block.id|string %}
  {% set default_code = block.default_code or '# Write your Python code here\n' %}
  <label for="{{ editor_id }}">{{ block.label or "Try it yourself:" }}</label>
  <div id="{{ editor_id }}" style="height: 300px; width: 100%; margin-bottom: 1em;"></div>
  <button type="button"
    class="run-code-btn"
    data-editor-id="{{ editor_id|e }}"
    data-content-id="{{ (block.content_id or editor_id)|e }}"
    data-next-topic="{{ (block.next_topic or '')|e }}">
    Run Code
  </button>
  <pre id="{{ editor_id }}-output" class="code-editor-output"></pre>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js" crossorigin="anonymous"></script>
<script>
  if (!window.aceEditors) window.aceEditors = {};
  (function() {
    var editorId = {{ editor_id|tojson|safe }};
    var defaultCode = {{ default_code|tojson|safe }};
    if (!window.aceEditors[editorId]) {
      var editor = ace.edit(editorId);
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/python");
      editor.setValue(defaultCode, -1);
      window.aceEditors[editorId] = editor;
    }
  })();

  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.run-code-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const editorId = btn.getAttribute('data-editor-id');
        const contentId = btn.getAttribute('data-content-id');
        const nextTopic = btn.getAttribute('data-next-topic');
        runStudentCodeWithProgress(editorId, contentId, nextTopic);
      });
    });
  });

  function runStudentCodeWithProgress(editorId, contentId, nextTopic) {
    var code = window.aceEditors[editorId].getValue();
    fetch('/run_python', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({code: code})
    })
    .then(res => res.json())
    .then(data => {
      let output = data.output || 'No output.';
      document.getElementById(editorId + '-output').textContent = output;
      // Mark as complete in user progress
      fetch('/api/update_progress', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          content_id: contentId,
          status: 'completed',
          type: 'lesson',
          timestamp: Date.now()
        })
      });
      // Mention next topic if provided
      if (nextTopic) {
        document.getElementById(editorId + '-output').textContent += `\n\nNext topic: ${nextTopic}`;
      }
    })
    .catch(() => {
      document.getElementById(editorId + '-output').textContent = 'Error running code.';
    });
  }
</script>
